#!/bin/bash
# =============================================================================
# SCRIPT DE REPORTE DE AMENAZAS CLAMAV
# Generated by Ansible Security Framework
# Date: {{ ansible_date_time.date }}
# =============================================================================

# Configuraci√≥n
LOG_FILE="/var/log/clamav/clamav.log"
REPORT_FILE="/var/log/ansible_security/threat_report_$(date +%Y%m%d).log"
EMAIL_REPORT="{{ antivirus_email_report | default('admin@localhost') }}"

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üõ°Ô∏è REPORTE DE AMENAZAS CLAMAV - $(date)" | tee -a "$REPORT_FILE"
echo "=================================================" | tee -a "$REPORT_FILE"

# Verificar si ClamAV est√° funcionando
if systemctl is-active --quiet clamav-daemon; then
    echo -e "${GREEN}‚úÖ ClamAV Daemon: ACTIVO${NC}" | tee -a "$REPORT_FILE"
else
    echo -e "${RED}‚ùå ClamAV Daemon: INACTIVO${NC}" | tee -a "$REPORT_FILE"
fi

# Verificar actualizaciones de base de datos
if systemctl is-active --quiet clamav-freshclam; then
    echo -e "${GREEN}‚úÖ ClamAV FreshClam: ACTIVO${NC}" | tee -a "$REPORT_FILE"
else
    echo -e "${YELLOW}‚ö†Ô∏è ClamAV FreshClam: VERIFICAR${NC}" | tee -a "$REPORT_FILE"
fi

# Buscar amenazas en los logs
if [[ -f "$LOG_FILE" ]]; then
    THREATS=$(grep -i "FOUND" "$LOG_FILE" | tail -20)
    if [[ -n "$THREATS" ]]; then
        echo -e "${RED}üö® AMENAZAS DETECTADAS:${NC}" | tee -a "$REPORT_FILE"
        echo "$THREATS" | tee -a "$REPORT_FILE"
    else
        echo -e "${GREEN}‚úÖ No se detectaron amenazas${NC}" | tee -a "$REPORT_FILE"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è Log de ClamAV no encontrado${NC}" | tee -a "$REPORT_FILE"
fi

# Estad√≠sticas de escaneo
SCANS_TODAY=$(grep "$(date +%Y-%m-%d)" "$LOG_FILE" 2>/dev/null | wc -l)
echo "üìä Escaneos realizados hoy: $SCANS_TODAY" | tee -a "$REPORT_FILE"

# Verificar espacio en disco para logs
DISK_USAGE=$(df /var/log | tail -1 | awk '{print $5}' | sed 's/%//')
if [[ $DISK_USAGE -gt 90 ]]; then
    echo -e "${RED}‚ö†Ô∏è ADVERTENCIA: Espacio en disco bajo ($DISK_USAGE%)${NC}" | tee -a "$REPORT_FILE"
else
    echo -e "${GREEN}‚úÖ Espacio en disco: $DISK_USAGE%${NC}" | tee -a "$REPORT_FILE"
fi

echo "=================================================" | tee -a "$REPORT_FILE"
echo "üïê Reporte generado: $(date)" | tee -a "$REPORT_FILE"

# Enviar reporte por email si hay amenazas (opcional)
{% if antivirus_email_alerts | default(false) %}
if [[ -n "$THREATS" ]]; then
    echo "Enviando alerta por email..."
    mail -s "üö® AMENAZAS DETECTADAS en {{ inventory_hostname }}" "$EMAIL_REPORT" < "$REPORT_FILE"
fi
{% endif %}

exit 0