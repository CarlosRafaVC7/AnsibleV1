---
# Rol principal de Seguridad Integral
# Configura iptables, firewall, pol√≠ticas ESXi y seguridad local

- name: "üîê INICIANDO CONFIGURACI√ìN DE SEGURIDAD INTEGRAL"
  ansible.builtin.debug:
    msg:
      - "=================================================="
      - "üîê SO-ANSIBLE SECURITY FRAMEWORK"
      - "=================================================="
      - "Host: {{ inventory_hostname }}"
      - "Sistema: {{ ansible_system }}"
      - "Grupos: {{ group_names | join(', ') }}"
      - "Fecha: {{ ansible_date_time.date }}"
      - "=================================================="
      - "Implementando seguridad integral:"
      - "‚úì Gesti√≥n de usuarios y grupos"
      - "‚úì Controles de acceso avanzados"
      - "‚úì Seguridad de bases de datos"
      - "‚úì Protecci√≥n de red y NIC"
      - "‚úì Monitoreo y alertas"
      - "=================================================="

# ==============================================
# 1. CONFIGURACI√ìN DE USUARIOS Y GRUPOS
# ==============================================
- name: "üë• Configurar usuarios y grupos espec√≠ficos por laboratorio"
  ansible.builtin.include_tasks: users_and_groups.yml
  tags:
    - users
    - groups
    - authentication

# ==============================================
# 2. CONTROLES DE ACCESO AVANZADOS
# ==============================================
- name: "üîí Implementar controles de acceso y PAM"
  ansible.builtin.include_tasks: access_control.yml
  tags:
    - access_control
    - pam
    - rbac

# ==============================================
# 3. SEGURIDAD DE BASES DE DATOS Y SERVICIOS
# ==============================================
- name: "üóÑÔ∏è Configurar seguridad de bases de datos y servicios"
  ansible.builtin.include_tasks: database_security.yml
  tags:
    - database
    - services
    - mysql
    - postgresql

# ==============================================
# 4. ANTIVIRUS Y PROTECCI√ìN ENDPOINT
# ==============================================
- name: "üõ°Ô∏è Configurar antivirus y protecci√≥n endpoint"
  ansible.builtin.include_tasks: antivirus_security.yml
  tags:
    - antivirus
    - endpoint
    - malware
    - protection

# ==============================================
# 5. SEGURIDAD DE RED Y NIC
# ==============================================
- name: "üåê Configurar seguridad de red e interfaces"
  ansible.builtin.include_tasks: network_security.yml
  tags:
    - network
    - nic
    - vlan
    - connectivity

# ==============================================
# 6. CONFIGURACI√ìN DE FIREWALL
# ==============================================
- name: "üõ°Ô∏è Configurar firewall avanzado"
  ansible.builtin.include_tasks: linux_security.yml
  when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"
  tags:
    - firewall
    - iptables
    - fail2ban
    - linux

- name: "ü™ü Configurar seguridad de Windows"
  ansible.builtin.include_tasks: windows_security.yml
  when: ansible_os_family == "Windows"
  tags:
    - firewall
    - windows
    - defender

# ==============================================
# 7. MONITOREO Y ALERTAS
# ==============================================
- name: "üìä Configurar monitoreo de seguridad"
  ansible.builtin.include_tasks: security_monitoring.yml
  tags:
    - monitoring
    - alerts
    - logging

# ==============================================
# 8. INFORMACI√ìN DEL SISTEMA
# ==============================================
- name: "üìã Recopilar informaci√≥n completa del sistema"
  ansible.builtin.include_tasks: system_info.yml
  tags:
    - info
    - dump
    - validation
    - always

# ==============================================
# 9. VALIDACI√ìN FINAL
# ==============================================
- name: "‚úÖ VALIDACI√ìN FINAL DE SEGURIDAD"
  ansible.builtin.debug:
    msg:
      - "=================================================="
      - "‚úÖ CONFIGURACI√ìN DE SEGURIDAD COMPLETADA"
      - "=================================================="
      - "Host: {{ inventory_hostname }} ({{ ansible_system }})"
      - ""
      - "üîê Componentes configurados:"
      - "  ‚úÖ Usuarios y grupos espec√≠ficos por laboratorio"
      - "  ‚úÖ Controles de acceso y pol√≠ticas PAM"
      - "  ‚úÖ Seguridad de bases de datos (MySQL/PostgreSQL)"
      - "  ‚úÖ Protecci√≥n antivirus y endpoint security"
      - "  ‚úÖ Protecci√≥n de servicios web (Apache/IIS)"
      - "  ‚úÖ Seguridad de red e interfaces NIC"
      - "  ‚úÖ Firewall y protecci√≥n perimetral"
      - "  ‚úÖ Monitoreo y sistema de alertas"
      - "  ‚úÖ Informaci√≥n del sistema recopilada"
      - ""
      - "üõ°Ô∏è Nivel de seguridad: ENTERPRISE GRADE"
      - "üìä Logs disponibles en: {{ monitoring.log_directory | default('/var/log/ansible_security') }}"
      - ""
      - "üéØ Siguiente paso:"
      - "   ansible-playbook tests/validate_configuration.yml"
      - "=================================================="
  tags:
    - validation
    - summary
    - always