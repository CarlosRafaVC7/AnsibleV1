---
# Configuraci√≥n avanzada de controles de acceso y PAM
# Implementaci√≥n de pol√≠ticas de seguridad estrictas

- name: "üîê CONFIGURACI√ìN DE CONTROLES DE ACCESO AVANZADOS"
  ansible.builtin.debug:
    msg:
      - "=================================================="
      - "üîê IMPLEMENTANDO CONTROLES DE ACCESO AVANZADOS"
      - "=================================================="
      - "Host: {{ inventory_hostname }}"
      - "Sistema: {{ ansible_system }}"
      - "Configurando PAM, pol√≠ticas y controles"
      - "=================================================="

# ==============================================
# CONFIGURACI√ìN PAM PARA LINUX
# ==============================================
- name: "Configurar PAM y controles de acceso en Linux"
  block:
    - name: "üì¶ Instalar paquetes de seguridad PAM"
      ansible.builtin.package:
        name: "{{ pam_packages[ansible_os_family] | default([]) }}"
        state: present
      vars:
        pam_packages:
          Debian:
            - libpam-pwquality
            - google-authenticator-libpam
            - libpam-tmpdir
            - libpam-modules-extra
          RedHat:
            - pam_pwquality
            - google-authenticator
            - pam_tmpdir
            - pam_cracklib
          Ubuntu:
            - libpam-pwquality
            - libpam-google-authenticator  
            - libpam-tmpdir
            - libpam-modules-extra
      ignore_errors: true

    - name: "üîí Configurar l√≠mites de recursos del sistema"
      ansible.builtin.template:
        src: "limits.conf.j2"
        dest: "/etc/security/limits.conf"
        backup: yes
        owner: root
        group: root
        mode: "0644"

    - name: "üõ°Ô∏è Configurar login.defs para pol√≠ticas de contrase√±as"
      ansible.builtin.template:
        src: "login.defs.j2"
        dest: "/etc/login.defs"
        backup: yes
        owner: root
        group: root
        mode: "0644"

    - name: "üîê Configurar PAM para SSH"
      ansible.builtin.copy:
        content: |
          # PAM configuration for SSH - Basic security
          auth       required     pam_env.so
          auth       sufficient   pam_unix.so nullok try_first_pass
          auth       requisite    pam_succeed_if.so uid >= 1000 quiet_success
          auth       required     pam_deny.so
          account    required     pam_nologin.so
          account    include      system-auth
          password   include      system-auth
          session    required     pam_selinux.so close
          session    required     pam_loginuid.so
          session    required     pam_selinux.so open env_params
          session    optional     pam_keyinit.so force revoke
          session    include      system-auth
          session    required     pam_limits.so
        dest: "/etc/pam.d/sshd"
        backup: yes
        owner: root
        group: root
        mode: "0644"

    - name: "‚è∞ Configurar tiempo de sesi√≥n y timeouts"
      ansible.builtin.lineinfile:
        path: "/etc/security/limits.conf"
        line: "{{ item }}"
        create: yes
      loop:
        - "* soft nofile 65536"
        - "* hard nofile 65536"
        - "* soft nproc 32768"
        - "* hard nproc 32768"
        - "@students soft maxlogins 3"
        - "@students hard maxlogins 5"
        - "@practice soft maxlogins 2"
        - "@practice hard maxlogins 3"

    - name: "üö´ Configurar restricciones de acceso por tiempo"
      ansible.builtin.template:
        src: "time.conf.j2"
        dest: "/etc/security/time.conf"
        backup: yes
        owner: root
        group: root
        mode: "0644"

    - name: "üîç Configurar auditd para monitoreo"
      ansible.builtin.package:
        name: auditd
        state: present

    - name: "üìã Configurar reglas de auditor√≠a"
      ansible.builtin.template:
        src: "audit.rules.j2"
        dest: "/etc/audit/rules.d/ansible-security.rules"
        backup: yes
        owner: root
        group: root
        mode: "0640"
      notify: restart auditd

    - name: "üîê Configurar AppArmor/SELinux (si est√° disponible)"
      ansible.builtin.package:
        name: apparmor
        state: present
      when: ansible_distribution == "Ubuntu" or ansible_distribution == "Debian"

  when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"
  tags:
    - access_control
    - pam
    - linux
    - security

# ==============================================
# CONFIGURACI√ìN DE POL√çTICAS WINDOWS
# ==============================================
- name: "Configurar pol√≠ticas de seguridad en Windows"
  block:
    - name: "üîí Configurar pol√≠ticas de cuenta locales"
      ansible.windows.win_shell: |
        # Configurar pol√≠ticas de contrase√±a
        secedit /configure /cfg {{ ansible_env.TEMP }}\security_policy.inf /db {{ ansible_env.TEMP }}\security.sdb
      vars:
        security_policy: |
          [System Access]
          MinimumPasswordAge = {{ gamer_password_policy.min_age | default(1) }}
          MaximumPasswordAge = {{ gamer_password_policy.max_age | default(90) }}
          MinimumPasswordLength = {{ gamer_password_policy.min_length | default(10) }}
          PasswordComplexity = {{ 1 if gamer_password_policy.complexity else 0 }}
          PasswordHistorySize = {{ gamer_password_policy.history | default(5) }}
          LockoutBadCount = {{ security.max_login_attempts | default(3) }}
          ResetLockoutCount = 30
          LockoutDuration = 30
          RequireLogonToChangePassword = 0
          ClearTextPassword = 0

    - name: "üõ°Ô∏è Configurar UAC (User Account Control)"
      ansible.windows.win_regedit:
        path: "{{ item.path }}"
        name: "{{ item.name }}"
        data: "{{ item.data }}"
        type: dword
      loop:
        - path: "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System"
          name: "ConsentPromptBehaviorAdmin"
          data: 2
        - path: "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System"
          name: "ConsentPromptBehaviorUser"
          data: 3
        - path: "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System"
          name: "EnableLUA"
          data: 1

    - name: "üö´ Configurar pol√≠ticas de restricci√≥n de software"
      ansible.windows.win_regedit:
        path: "{{ item.path }}"
        name: "{{ item.name }}"
        data: "{{ item.data }}"
        type: dword
      loop:
        - path: "HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\Safer\\CodeIdentifiers"
          name: "DefaultLevel"
          data: 0x00040000
        - path: "HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\Safer\\CodeIdentifiers"
          name: "PolicyScope"
          data: 0

    - name: "‚è∞ Configurar pol√≠ticas de sesi√≥n"
      ansible.windows.win_regedit:
        path: "{{ item.path }}"
        name: "{{ item.name }}"
        data: "{{ item.data }}"
        type: dword
      loop:
        - path: "HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp"
          name: "MaxConnectionTime"
          data: "{{ security.session_timeout | default(1800) }}000"  # En milisegundos
        - path: "HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp"
          name: "MaxDisconnectionTime"
          data: 900000  # 15 minutos

    - name: "üîç Configurar auditor√≠a de Windows"
      ansible.windows.win_shell: |
        # Habilitar auditor√≠a de eventos de logon
        auditpol /set /category:"Logon/Logoff" /success:enable /failure:enable
        
        # Habilitar auditor√≠a de eventos de acceso a objetos
        auditpol /set /category:"Object Access" /success:enable /failure:enable
        
        # Habilitar auditor√≠a de cambios de pol√≠ticas
        auditpol /set /category:"Policy Change" /success:enable /failure:enable
        
        # Habilitar auditor√≠a de gesti√≥n de cuentas
        auditpol /set /category:"Account Management" /success:enable /failure:enable

  when: ansible_os_family == "Windows"
  tags:
    - access_control
    - windows
    - security
    - policies

# ==============================================
# CONFIGURACI√ìN DE ACCESO POR ROLES
# ==============================================
- name: "üéØ Configurar control de acceso basado en roles (RBAC)"
  block:
    - name: "üë• Configurar grupos de acceso por horarios (Linux)"
      ansible.builtin.lineinfile:
        path: "/etc/security/time.conf"
        line: "{{ item }}"
        create: yes
      loop:
        - "students;*;*;Mo-Fr0800-1800"  # Estudiantes solo L-V 8am-6pm
        - "practice;*;*;Mo-Fr0900-1700"  # Pr√°cticas solo L-V 9am-5pm
        - "academic_admin;*;*;Al0000-2400"  # Admin 24/7
      when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"

    - name: "üö™ Configurar restricciones de acceso remoto"
      ansible.builtin.template:
        src: "access.conf.j2"
        dest: "/etc/security/access.conf"
        backup: yes
      when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"

    - name: "üîê Configurar restricciones SSH por grupo"
      ansible.builtin.blockinfile:
        path: "/etc/ssh/sshd_config"
        block: |
          # Restricciones de acceso por grupo
          AllowGroups sudo academic_admin students
          DenyUsers practice_user
          MaxAuthTries {{ ssh.max_auth_tries | default(3) }}
          LoginGraceTime {{ ssh.login_grace_time | default(60) }}
          
          # Configuraci√≥n de seguridad adicional
          PermitEmptyPasswords {{ 'yes' if ssh.permit_empty_passwords else 'no' }}
          PasswordAuthentication {{ 'yes' if ssh.password_authentication else 'no' }}
          PubkeyAuthentication {{ 'yes' if ssh.pubkey_authentication else 'no' }}
        marker: "# {mark} ANSIBLE MANAGED BLOCK - SSH SECURITY"
      when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"
      notify: restart ssh

  tags:
    - rbac
    - access_control
    - security

# ==============================================
# CONFIGURACI√ìN DE MONITOREO DE ACCESO
# ==============================================
- name: "üìä Configurar monitoreo de acceso y alertas"
  block:
    - name: "üìù Crear script de monitoreo de acceso"
      ansible.builtin.template:
        src: "access_monitor.sh.j2"
        dest: "/usr/local/bin/access_monitor.sh"
        mode: "0755"
        owner: root
        group: root
      when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"

    - name: "‚è∞ Configurar cron para monitoreo de acceso"
      ansible.builtin.cron:
        name: "Monitor de acceso de seguridad"
        minute: "*/5"
        job: "/usr/local/bin/access_monitor.sh"
        user: root
      when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"

    - name: "üìã Crear log de eventos de acceso"
      ansible.builtin.file:
        path: "{{ monitoring.log_directory }}/access_events.log"
        state: touch
        owner: root
        group: root
        mode: "0640"
      when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"

  tags:
    - monitoring
    - access_control
    - security

# ==============================================
# VALIDACI√ìN DE CONFIGURACI√ìN
# ==============================================
- name: "‚úÖ Validar configuraci√≥n de controles de acceso"
  block:
    - name: "üîç Verificar configuraci√≥n PAM"
      ansible.builtin.command: "pam-auth-update --package"
      register: pam_status
      when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"
      changed_when: false

    - name: "üìä Mostrar resumen de controles configurados"
      ansible.builtin.debug:
        msg:
          - "=== CONTROLES DE ACCESO CONFIGURADOS ==="
          - "Host: {{ inventory_hostname }}"
          - "Sistema: {{ ansible_system }}"
          - "PAM configurado: {{ '‚úÖ' if pam_status is defined and pam_status.rc == 0 else '‚ùå' }}"
          - "L√≠mites de recursos: ‚úÖ Configurado"
          - "Pol√≠ticas de contrase√±a: ‚úÖ Aplicadas"
          - "Auditor√≠a: ‚úÖ Habilitada"
          - "RBAC: ‚úÖ Implementado"
          - "Estado: ‚úÖ Configuraci√≥n completada"

  tags:
    - validation
    - access_control