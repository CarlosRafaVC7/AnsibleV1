---
# =========================================
# CONFIGURACIÃ“N DE FIREWALL Y SEGURIDAD - LINUX
# Sistema: Ubuntu/Mint
# PropÃ³sito: Firewall, antivirus, fail2ban y red segura
# =========================================

- name: "ğŸ§ INICIANDO CONFIGURACIÃ“N DE SEGURIDAD LINUX"
  ansible.builtin.debug:
    msg:
      - "ğŸ§ Configurando firewall, antivirus y red en Linux"
      - "ğŸ“‹ DistribuciÃ³n: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - "ğŸŒ Red actual: DHCPv6 con IPv4 fallback"

# =========================================
# INSTALACIÃ“N DE PAQUETES DE SEGURIDAD
# =========================================

- name: "ğŸ“¦ Instalar paquetes de seguridad y firewall"
  ansible.builtin.apt:
    name:
      # Firewall y red
      - ufw                    # Firewall simplificado para Ubuntu
      - iptables              # Firewall avanzado
      - iptables-persistent   # Persistencia de reglas iptables
      - netfilter-persistent  # GestiÃ³n de reglas netfilter
      # Antivirus
      - clamav               # Motor antivirus
      - clamav-daemon        # Demonio de ClamAV
      - clamav-freshclam     # Actualizador de firmas
      - clamav-unofficial-sigs # Firmas no oficiales adicionales
      # ProtecciÃ³n SSH
      - fail2ban             # ProtecciÃ³n contra ataques de fuerza bruta
      # Red y conectividad
      - netplan.io           # ConfiguraciÃ³n de red
      - net-tools            # Herramientas de red clÃ¡sicas
      - iputils-ping         # Herramienta ping
      - dnsutils             # Herramientas DNS
    state: present
    update_cache: true
  become: true
  tags:
    - paquetes
    - firewall
    - antivirus

# =========================================
# CONFIGURACIÃ“N DE UFW (FIREWALL SIMPLIFICADO)
# =========================================

- name: "ğŸ”¥ Restablecer UFW a configuraciÃ³n por defecto"
  community.general.ufw:
    state: reset
  become: true
  tags:
    - firewall
    - ufw

- name: "ğŸ”’ Configurar polÃ­tica por defecto UFW (DENEGAR TODO)"
  community.general.ufw:
    policy: deny
    direction: "{{ item }}"
  loop:
    - incoming    # Denegar todo trÃ¡fico entrante por defecto
    - outgoing    # Permitir todo trÃ¡fico saliente por defecto se cambiarÃ¡ despuÃ©s
  become: true
  tags:
    - firewall
    - politicas

- name: "âœ… Permitir SSH solo desde red autorizada (192.168.1.0/24)"
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp
    src: "{{ item }}"
    comment: "SSH desde red autorizada"
  loop:
    - "192.168.1.0/24"      # Red local permitida
    - "127.0.0.1"           # Localhost siempre permitido
  become: true
  tags:
    - firewall
    - ssh

- name: "ğŸŒ Permitir puertos seguros para servicios web"
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
    comment: "{{ item.comment }}"
  loop:
    - { port: "80", proto: "tcp", comment: "HTTP - Servidor web Apache/Nginx" }
    - { port: "443", proto: "tcp", comment: "HTTPS - Servidor web seguro" }
    - { port: "53", proto: "udp", comment: "DNS - ResoluciÃ³n de nombres" }
    - { port: "123", proto: "udp", comment: "NTP - SincronizaciÃ³n de tiempo" }
  become: true
  tags:
    - firewall
    - servicios

- name: "ğŸš« Denegar puertos peligrosos explÃ­citamente"
  community.general.ufw:
    rule: deny
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
    comment: "{{ item.comment }}"
  loop:
    - { port: "23", proto: "tcp", comment: "DENEGAR Telnet - Protocolo inseguro" }
    - { port: "21", proto: "tcp", comment: "DENEGAR FTP - Protocolo sin cifrado" }
    - { port: "135", proto: "tcp", comment: "DENEGAR RPC Endpoint - Windows legacy" }
    - { port: "139", proto: "tcp", comment: "DENEGAR NetBIOS - Protocolo legacy" }
    - { port: "445", proto: "tcp", comment: "DENEGAR SMB - ComparticiÃ³n Windows" }
    - { port: "1433", proto: "tcp", comment: "DENEGAR SQL Server - Base de datos" }
    - { port: "3389", proto: "tcp", comment: "DENEGAR RDP - Escritorio remoto Windows" }
  become: true
  tags:
    - firewall
    - seguridad

- name: "ğŸ”¥ Habilitar UFW firewall"
  community.general.ufw:
    state: enabled
    logging: "on"  # Habilitar logging para auditorÃ­a
  become: true
  tags:
    - firewall
    - activacion

# =========================================
# CONFIGURACIÃ“N AVANZADA DE IPTABLES
# =========================================

- name: "âš™ï¸ Configurar reglas avanzadas de iptables"
  ansible.builtin.iptables:
    chain: "{{ item.chain }}"
    rule: "{{ item.rule }}"
    jump: "{{ item.jump }}"
    comment: "{{ item.comment }}"
  loop:
    # ProtecciÃ³n contra ataques de red
    - { chain: "INPUT", rule: "-p tcp --tcp-flags ALL NONE", jump: "DROP", comment: "Anti NULL packets attack" }
    - { chain: "INPUT", rule: "-p tcp --tcp-flags ALL ALL", jump: "DROP", comment: "Anti XMAS packets attack" }
    - { chain: "INPUT", rule: "-p tcp --tcp-flags ALL FIN,URG,PSH", jump: "DROP", comment: "Anti stealth scans" }
    
    # ProtecciÃ³n contra flood de conexiones
    - { chain: "INPUT", rule: "-p tcp --dport 22 -m conntrack --ctstate NEW -m recent --set --name SSH", jump: "ACCEPT", comment: "SSH rate limiting setup" }
    - { chain: "INPUT", rule: "-p tcp --dport 22 -m conntrack --ctstate NEW -m recent --update --seconds 60 --hitcount 4 --rttl --name SSH", jump: "DROP", comment: "SSH rate limiting drop" }
    
    # ProtecciÃ³n ICMP limitada
    - { chain: "INPUT", rule: "-p icmp --icmp-type echo-request -m limit --limit 1/s --limit-burst 2", jump: "ACCEPT", comment: "Ping limitado anti-flood" }
    
    # Conexiones establecidas siempre permitidas
    - { chain: "INPUT", rule: "-m state --state ESTABLISHED,RELATED", jump: "ACCEPT", comment: "Permitir conexiones establecidas" }
  become: true
  tags:
    - iptables
    - proteccion

- name: "ğŸ’¾ Guardar reglas de iptables permanentemente"
  ansible.builtin.shell: |
    iptables-save > /etc/iptables/rules.v4
    ip6tables-save > /etc/iptables/rules.v6
  become: true
  tags:
    - iptables
    - persistencia

# =========================================
# CONFIGURACIÃ“N DE CLAMAV (ANTIVIRUS)
# =========================================

- name: "ğŸ¦  Detener ClamAV para configuraciÃ³n inicial"
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
  loop:
    - clamav-daemon
    - clamav-freshclam
  become: true
  ignore_errors: true
  tags:
    - antivirus
    - clamav

- name: "ğŸ”„ Actualizar base de datos de firmas de ClamAV"
  ansible.builtin.command: freshclam
  become: true
  timeout: 300  # 5 minutos timeout para descarga
  ignore_errors: true  # Puede fallar si no hay internet
  tags:
    - antivirus
    - actualizacion

- name: "âš™ï¸ Configurar ClamAV daemon"
  ansible.builtin.lineinfile:
    path: /etc/clamav/clamd.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    backup: true
  loop:
    - { regexp: "^#LocalSocket", line: "LocalSocket /var/run/clamav/clamd.ctl" }
    - { regexp: "^#User", line: "User clamav" }
    - { regexp: "^#ScanPE", line: "ScanPE yes" }
    - { regexp: "^#ScanELF", line: "ScanELF yes" }
    - { regexp: "^#DetectPUA", line: "DetectPUA yes" }
    - { regexp: "^#ScanArchive", line: "ScanArchive yes" }
  become: true
  notify: restart_clamav
  tags:
    - antivirus
    - configuracion

- name: "ğŸ• Configurar escaneo automÃ¡tico nocturno"
  ansible.builtin.cron:
    name: "ClamAV full system scan"
    minute: "30"
    hour: "2"
    job: "/usr/bin/clamscan -r --bell -i --log=/var/log/clamav/scan.log --exclude-dir=^/sys --exclude-dir=^/proc /home /opt /tmp /var/log 2>&1"
    user: root
    cron_file: clamav_scan
  become: true
  tags:
    - antivirus
    - automatizacion

- name: "ğŸš€ Iniciar servicios de ClamAV"
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: true
    daemon_reload: true
  loop:
    - clamav-freshclam    # Actualizador de firmas
    - clamav-daemon       # Motor antivirus
  become: true
  tags:
    - antivirus
    - servicios

# =========================================
# CONFIGURACIÃ“N DE FAIL2BAN
# =========================================

- name: "ğŸ›¡ï¸ Configurar Fail2ban para protecciÃ³n SSH"
  ansible.builtin.template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    backup: true
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: restart_fail2ban
  tags:
    - fail2ban
    - proteccion

- name: "ğŸ“ Crear configuraciÃ³n adicional de Fail2ban"
  ansible.builtin.copy:
    content: |
      # ConfiguraciÃ³n personalizada para laboratorio
      [DEFAULT]
      # Tiempo de banneo aumentado para mayor seguridad
      bantime = 1800          # 30 minutos
      findtime = 600          # Ventana de 10 minutos
      maxretry = 3            # MÃ¡ximo 3 intentos
      
      # ConfiguraciÃ³n de logging
      logtarget = /var/log/fail2ban.log
      loglevel = INFO
      
      # Ignorar IPs locales
      ignoreip = 127.0.0.1/8 192.168.1.0/24
      
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 1800
      findtime = 600
    dest: /etc/fail2ban/jail.d/laboratorio.conf
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: restart_fail2ban
  tags:
    - fail2ban
    - configuracion

- name: "ğŸš€ Iniciar y habilitar Fail2ban"
  ansible.builtin.systemd:
    name: fail2ban
    state: started
    enabled: true
    daemon_reload: true
  become: true
  tags:
    - fail2ban
    - servicios

# =========================================
# CONFIGURACIÃ“N DE RED DHCPv6 CON NETPLAN
# =========================================

- name: "ğŸŒ Configurar red DHCPv6 con IPv4 fallback usando Netplan"
  ansible.builtin.template:
    src: netplan_dhcpv6.yaml.j2
    dest: /etc/netplan/01-netcfg.yaml
    backup: true
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: apply_netplan
  tags:
    - red
    - dhcpv6
    - netplan

# =========================================
# VALIDACIÃ“N Y PRUEBAS DE CONECTIVIDAD
# =========================================

- name: "âœ… Verificar estado de servicios de seguridad"
  ansible.builtin.systemd:
    name: "{{ item }}"
  loop:
    - ufw
    - clamav-daemon
    - fail2ban
  register: services_status
  become: true
  tags:
    - validacion
    - servicios

- name: "ğŸ” Probar conectividad bÃ¡sica"
  ansible.builtin.ping:
  tags:
    - validacion
    - conectividad

- name: "ğŸ“Š Mostrar estado de UFW"
  ansible.builtin.command: ufw status verbose
  register: ufw_status
  become: true
  changed_when: false
  tags:
    - validacion
    - firewall

- name: "ğŸ“‹ Mostrar informaciÃ³n de configuraciÃ³n completada"
  ansible.builtin.debug:
    msg:
      - "âœ… ConfiguraciÃ³n de seguridad Linux completada"
      - "ğŸ”¥ UFW Firewall: {{ 'ACTIVO' if 'Status: active' in ufw_status.stdout else 'INACTIVO' }}"
      - "ğŸ¦  ClamAV: {{ 'ACTIVO' if services_status.results[1].status.ActiveState == 'active' else 'REVISAR' }}"
      - "ğŸ›¡ï¸  Fail2ban: {{ 'ACTIVO' if services_status.results[2].status.ActiveState == 'active' else 'REVISAR' }}"
      - "ğŸ“‹ Puertos permitidos: SSH(22-red local), HTTP(80), HTTPS(443)"
      - "ğŸš« Puertos bloqueados: Telnet(23), FTP(21), SMB(445), RDP(3389)"
      - "ğŸŒ Red: DHCPv6 con IPv4 fallback configurado"
  tags:
    - validacion
    - resumen