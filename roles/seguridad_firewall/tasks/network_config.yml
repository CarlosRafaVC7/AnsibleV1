---
# =========================================
# CONFIGURACIÃ“N DE RED COMÃšN DHCPv6
# Compatible con Linux y Windows
# PropÃ³sito: Red hÃ­brida IPv6/IPv4 con DHCPv6
# =========================================

- name: "ğŸŒ CONFIGURACIÃ“N DE RED DHCPv6 COMÃšN"
  ansible.builtin.debug:
    msg:
      - "ğŸŒ Aplicando configuraciÃ³n de red DHCPv6 hÃ­brida"
      - "ğŸ“‹ Host: {{ inventory_hostname }}"
      - "ğŸ–¥ï¸  Sistema: {{ ansible_system }}"

# =========================================
# CONFIGURACIÃ“N COMÃšN DE CONECTIVIDAD
# =========================================

- name: "ğŸ” Verificar conectividad de red actual"
  ansible.builtin.ping:
  tags:
    - red
    - conectividad

- name: "ğŸ“Š Mostrar informaciÃ³n de red actual"
  ansible.builtin.setup:
    filter: ansible_default_ipv*
  register: network_info
  tags:
    - red
    - informacion

- name: "ğŸŒ Verificar soporte IPv6 del sistema"
  ansible.builtin.shell: |
    {% if ansible_os_family == "Debian" or ansible_distribution == "Ubuntu" %}
    ip -6 addr show | grep inet6 | head -3
    {% elif ansible_os_family == "Windows" %}
    Get-NetIPAddress -AddressFamily IPv6 | Where-Object {$_.IPAddress -notlike "fe80:*"} | Select-Object IPAddress | ConvertTo-Json -Compress
    {% endif %}
  register: ipv6_check
  changed_when: false
  ignore_errors: true
  tags:
    - red
    - ipv6

# =========================================
# CONFIGURACIÃ“N DE DNS HÃBRIDO
# =========================================

- name: "ğŸ”§ Configurar resoluciÃ³n DNS hÃ­brida IPv6/IPv4"
  block:
    # ConfiguraciÃ³n DNS para Linux
    - name: "ğŸ§ Configurar DNS en Linux (systemd-resolved)"
      ansible.builtin.template:
        src: resolved.conf.j2
        dest: /etc/systemd/resolved.conf
        backup: true
        owner: root
        group: root
        mode: "0644"
      become: true
      when: ansible_os_family == "Debian" or ansible_distribution == "Ubuntu"
      notify: restart_systemd_resolved

    # ConfiguraciÃ³n DNS para Windows ya estÃ¡ en windows_firewall.yml
    
  tags:
    - dns
    - resolucion

# =========================================
# CONFIGURACIÃ“N DE ROUTING Y GATEWAY
# =========================================

- name: "ğŸ›¤ï¸ Configurar tabla de rutas para red hÃ­brida"
  ansible.builtin.shell: |
    {% if ansible_os_family == "Debian" or ansible_distribution == "Ubuntu" %}
    # Verificar rutas IPv6 actuales
    ip -6 route show | head -5
    
    # Configurar ruta por defecto IPv6 si estÃ¡ disponible
    if ip -6 addr show | grep -q "2001:"; then
        echo "IPv6 global disponible"
    else
        echo "Esperando configuraciÃ³n DHCPv6"
    fi
    {% elif ansible_os_family == "Windows" %}
    # Verificar tabla de rutas IPv6
    Get-NetRoute -AddressFamily IPv6 | Where-Object {$_.DestinationPrefix -eq "::/0"} | Select-Object NextHop | ConvertTo-Json -Compress
    {% endif %}
  register: routing_info
  changed_when: false
  tags:
    - routing
    - gateway

# =========================================
# CONFIGURACIÃ“N DE TIEMPO Y NTP
# =========================================

- name: "â° Configurar sincronizaciÃ³n de tiempo con servidores NTP"
  block:
    # ConfiguraciÃ³n NTP para Linux
    - name: "ğŸ§ Configurar NTP en Linux"
      ansible.builtin.shell: |
        # Configurar timesyncd (systemd)
        timedatectl set-ntp true
        
        # Verificar sincronizaciÃ³n
        timedatectl status | grep "Network time"
      become: true
      when: ansible_os_family == "Debian" or ansible_distribution == "Ubuntu"

    # ConfiguraciÃ³n NTP para Windows
    - name: "ğŸªŸ Configurar NTP en Windows"
      ansible.windows.win_shell: |
        # Configurar servidor NTP
        w32tm /config /manualpeerlist:"pool.ntp.org time.cloudflare.com" /syncfromflags:manual /reliable:yes /update
        
        # Reiniciar servicio de tiempo
        Restart-Service w32time
        
        # Sincronizar inmediatamente
        w32tm /resync
      when: ansible_os_family == "Windows"

  tags:
    - ntp
    - tiempo

# =========================================
# PRUEBAS DE CONECTIVIDAD FINAL
# =========================================

- name: "ğŸ” Probar conectividad IPv6 e IPv4"
  ansible.builtin.shell: |
    {% if ansible_os_family == "Debian" or ansible_distribution == "Ubuntu" %}
    # Prueba ping IPv6
    echo "=== Prueba IPv6 ==="
    ping6 -c 2 2001:4860:4860::8888 2>/dev/null || echo "IPv6 no disponible aÃºn"
    
    # Prueba ping IPv4
    echo "=== Prueba IPv4 ==="
    ping -c 2 8.8.8.8 2>/dev/null || echo "IPv4 no disponible"
    {% elif ansible_os_family == "Windows" %}
    # Prueba ping IPv6
    Write-Output "=== Prueba IPv6 ==="
    Test-NetConnection -ComputerName "2001:4860:4860::8888" -Port 53 -InformationLevel Quiet 2>$null
    
    # Prueba ping IPv4  
    Write-Output "=== Prueba IPv4 ==="
    Test-NetConnection -ComputerName "8.8.8.8" -Port 53 -InformationLevel Quiet 2>$null
    {% endif %}
  register: connectivity_test
  changed_when: false
  ignore_errors: true
  tags:
    - validacion
    - conectividad

- name: "ğŸ“Š Mostrar resumen de configuraciÃ³n de red"
  ansible.builtin.debug:
    msg:
      - "ğŸŒ ConfiguraciÃ³n de red DHCPv6 completada"
      - "ğŸ“‹ Host: {{ inventory_hostname }}"
      - "ğŸ–¥ï¸  Sistema: {{ ansible_system }}"
      - "ğŸ“¡ IPv6: {{ 'Detectado' if '2001:' in ipv6_check.stdout else 'DHCPv6 en progreso' }}"
      - "ğŸ“¡ IPv4: {{ ansible_default_ipv4.address | default('DHCP en progreso') }}"
      - "ğŸ”§ DNS: Configurado para resoluciÃ³n hÃ­brida"
      - "â° NTP: SincronizaciÃ³n habilitada"
      - "âœ… Conectividad: {{ 'OK' if connectivity_test.rc == 0 else 'En configuraciÃ³n' }}"
  tags:
    - resumen
    - red