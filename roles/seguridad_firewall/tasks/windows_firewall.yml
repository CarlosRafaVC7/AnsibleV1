---
# =========================================
# CONFIGURACI√ìN DE FIREWALL Y SEGURIDAD - WINDOWS
# Sistema: Windows 11 Pro
# Prop√≥sito: Windows Defender Firewall, antivirus y red
# =========================================

- name: "ü™ü INICIANDO CONFIGURACI√ìN DE SEGURIDAD WINDOWS"
  ansible.builtin.debug:
    msg:
      - "ü™ü Configurando Windows Defender Firewall y seguridad"
      - "üìã Sistema: {{ ansible_system }} {{ ansible_distribution }}"
      - "üåê Red: DHCPv6 con IPv4 fallback"

# =========================================
# CONFIGURACI√ìN DE WINDOWS DEFENDER FIREWALL
# =========================================

- name: "üî• Habilitar Windows Defender Firewall en todos los perfiles"
  ansible.windows.win_firewall:
    state: enabled
    profiles:
      - domain      # Perfil de dominio (redes corporativas)
      - private     # Perfil privado (redes dom√©sticas/trabajo)
      - public      # Perfil p√∫blico (redes no confiables)
  tags:
    - firewall
    - windows

- name: "üîí Configurar pol√≠tica por defecto del firewall (BLOQUEAR TODO)"
  ansible.windows.win_shell: |
    # Configurar pol√≠tica por defecto para BLOQUEAR conexiones entrantes
    netsh advfirewall set allprofiles firewallpolicy blockinbound,allowoutbound
    
    # Habilitar logging para auditor√≠a
    netsh advfirewall set allprofiles logging filename %systemroot%\system32\logfiles\firewall\pfirewall.log
    netsh advfirewall set allprofiles logging maxfilesize 4096
    netsh advfirewall set allprofiles logging droppedconnections enable
    netsh advfirewall set allprofiles logging allowedconnections enable
  tags:
    - firewall
    - politicas

# =========================================
# REGLAS DE FIREWALL PARA PUERTOS SEGUROS
# =========================================

- name: "‚úÖ Permitir SSH/WinRM solo desde red autorizada (192.168.1.0/24)"
  community.windows.win_firewall_rule:
    name: "{{ item.name }}"
    localport: "{{ item.port }}"
    action: allow
    direction: in
    protocol: tcp
    profiles:
      - private
      - domain
    remoteip: 
      - "192.168.1.0/24"
      - "127.0.0.1"
    description: "{{ item.description }}"
    enabled: true
  loop:
    - { name: "SSH-Seguro-Lab", port: "22", description: "SSH desde red autorizada para gesti√≥n" }
    - { name: "WinRM-HTTP-Lab", port: "5985", description: "WinRM HTTP para Ansible desde red local" }
    - { name: "WinRM-HTTPS-Lab", port: "5986", description: "WinRM HTTPS para Ansible desde red local" }
  tags:
    - firewall
    - ssh
    - winrm

- name: "üåê Permitir servicios web seguros"
  community.windows.win_firewall_rule:
    name: "{{ item.name }}"
    localport: "{{ item.port }}"
    action: allow
    direction: in
    protocol: tcp
    profiles:
      - private
      - domain
    description: "{{ item.description }}"
    enabled: true
  loop:
    - { name: "HTTP-Seguro-Lab", port: "80", description: "HTTP para IIS/Apache" }
    - { name: "HTTPS-Seguro-Lab", port: "443", description: "HTTPS para servicios web seguros" }
  tags:
    - firewall
    - servicios

- name: "üö´ BLOQUEAR puertos peligrosos expl√≠citamente"
  community.windows.win_firewall_rule:
    name: "{{ item.name }}"
    localport: "{{ item.port }}"
    action: block
    direction: in
    protocol: tcp
    profiles:
      - public
      - private
      - domain
    description: "{{ item.description }}"
    enabled: true
  loop:
    - { name: "BLOCK-Telnet-Lab", port: "23", description: "BLOQUEAR Telnet - Protocolo inseguro" }
    - { name: "BLOCK-FTP-Lab", port: "21", description: "BLOQUEAR FTP - Sin cifrado" }
    - { name: "BLOCK-SNMP-Lab", port: "161", description: "BLOQUEAR SNMP - Informaci√≥n del sistema" }
    - { name: "BLOCK-NetBIOS-Lab", port: "139", description: "BLOQUEAR NetBIOS - Protocolo legacy" }
    - { name: "BLOCK-SMB-Lab", port: "445", description: "BLOQUEAR SMB directo - Riesgo de seguridad" }
  tags:
    - firewall
    - seguridad

# =========================================
# CONFIGURACI√ìN DE WINDOWS DEFENDER
# =========================================

- name: "ü¶† Configurar Windows Defender Antivirus"
  ansible.windows.win_shell: |
    # Habilitar protecci√≥n en tiempo real
    Set-MpPreference -DisableRealtimeMonitoring $false
    
    # Configurar comportamiento del antivirus
    Set-MpPreference -DisableBehaviorMonitoring $false
    Set-MpPreference -DisableBlockAtFirstSeen $false
    Set-MpPreference -DisableIOAVProtection $false
    Set-MpPreference -DisableScriptScanning $false
    
    # Configurar env√≠o de muestras y telemetr√≠a
    Set-MpPreference -SubmitSamplesConsent 1               # Env√≠o autom√°tico de muestras
    Set-MpPreference -MAPSReporting 2                      # Participaci√≥n avanzada en MAPS
    
    # Configurar acciones para amenazas
    Set-MpPreference -HighThreatDefaultAction Remove       # Eliminar amenazas altas
    Set-MpPreference -ModerateThreatDefaultAction Remove   # Eliminar amenazas moderadas
    Set-MpPreference -LowThreatDefaultAction Remove        # Eliminar amenazas bajas
    Set-MpPreference -SevereThreatDefaultAction Remove     # Eliminar amenazas severas
    
    # Configurar exclusiones para rendimiento (solo directorios seguros)
    Add-MpPreference -ExclusionPath "C:\Windows\Temp"
    Add-MpPreference -ExclusionPath "C:\Users\*\AppData\Local\Temp"
  tags:
    - antivirus
    - defender

- name: "üîÑ Actualizar definiciones de Windows Defender"
  ansible.windows.win_shell: |
    # Forzar actualizaci√≥n de definiciones
    Update-MpSignature -UpdateSource MicrosoftUpdateServer
    
    # Verificar estado de las definiciones
    $status = Get-MpComputerStatus
    Write-Output "Versi√≥n antivirus: $($status.AntivirusSignatureVersion)"
    Write-Output "√öltima actualizaci√≥n: $($status.AntivirusSignatureLastUpdated)"
    Write-Output "Protecci√≥n en tiempo real: $($status.RealTimeProtectionEnabled)"
  register: defender_update
  tags:
    - antivirus
    - actualizacion

- name: "üïê Configurar escaneo autom√°tico nocturno"
  community.windows.win_scheduled_task:
    name: "Windows Defender Full Scan"
    description: "Escaneo completo nocturno del sistema con Windows Defender"
    actions:
      - path: 'powershell.exe'
        arguments: '-Command "Start-MpScan -ScanType FullScan"'
    triggers:
      - type: daily
        start_boundary: "2025-01-01T02:00:00"
        repetition:
          interval: P1D  # Diario
    settings:
      start_when_available: true
      run_only_if_network_available: false
    state: present
  tags:
    - antivirus
    - automatizacion

# =========================================
# CONFIGURACI√ìN DE RED DHCPv6
# =========================================

- name: "üåê Configurar adaptador de red para DHCPv6 con IPv4 fallback"
  ansible.windows.win_shell: |
    # Obtener el adaptador de red principal
    $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up" -and $_.Virtual -eq $false} | Select-Object -First 1
    $interfaceAlias = $adapter.InterfaceAlias
    
    Write-Output "Configurando adaptador: $interfaceAlias"
    
    # Habilitar DHCPv6 (IPv6 autom√°tico)
    Set-NetIPInterface -InterfaceAlias $interfaceAlias -AddressFamily IPv6 -Dhcp Enabled
    Set-NetIPInterface -InterfaceAlias $interfaceAlias -AddressFamily IPv6 -RouterDiscovery Enabled
    
    # Configurar IPv4 como fallback (mantener DHCP por defecto)
    Set-NetIPInterface -InterfaceAlias $interfaceAlias -AddressFamily IPv4 -Dhcp Enabled
    
    # Configurar preferencias IPv6
    Set-Net6to4Configuration -State Disabled
    Set-NetTeredoConfiguration -Type Disabled
    Set-NetIsatapConfiguration -State Disabled
    
    # Priorizar IPv6 sobre IPv4
    netsh interface ipv6 set global randomizeidentifiers=disabled
    netsh interface ipv6 set privacy state=disabled
    
    Write-Output "Configuraci√≥n de red DHCPv6 completada"
  register: network_config
  tags:
    - red
    - dhcpv6

- name: "üîß Configurar DNS para IPv6"
  ansible.windows.win_shell: |
    # Configurar DNS IPv6 (Google DNS y Cloudflare)
    $adapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up" -and $_.Virtual -eq $false} | Select-Object -First 1
    
    # DNS IPv6
    Set-DnsClientServerAddress -InterfaceAlias $adapter.InterfaceAlias -ServerAddresses @("2001:4860:4860::8888", "2001:4860:4860::8844", "2606:4700:4700::1111")
    
    # DNS IPv4 como fallback
    Set-DnsClientServerAddress -InterfaceAlias $adapter.InterfaceAlias -ServerAddresses @("8.8.8.8", "8.8.4.4", "1.1.1.1") -ResetServerAddresses:$false
    
    Write-Output "DNS IPv6 configurado correctamente"
  tags:
    - red
    - dns

# =========================================
# CONFIGURACI√ìN ADICIONAL DE SEGURIDAD
# =========================================

- name: "üîí Configurar pol√≠ticas de seguridad adicionales"
  ansible.windows.win_regedit:
    path: "{{ item.path }}"
    name: "{{ item.name }}"
    data: "{{ item.value }}"
    type: dword
  loop:
    # Deshabilitar AutoRun/AutoPlay (prevenci√≥n de malware USB)
    - { path: "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer", name: "NoDriveTypeAutoRun", value: 255 }
    - { path: "HKCU:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer", name: "NoDriveTypeAutoRun", value: 255 }
    
    # Configurar UAC m√°s estricto
    - { path: "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System", name: "ConsentPromptBehaviorAdmin", value: 2 }
    - { path: "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System", name: "PromptOnSecureDesktop", value: 1 }
  tags:
    - seguridad
    - registro

- name: "üö´ Deshabilitar servicios innecesarios para seguridad"
  ansible.windows.win_service:
    name: "{{ item }}"
    state: stopped
    start_mode: disabled
  loop:
    - "Fax"                    # Servicio de fax
    - "TapiSrv"               # Telefon√≠a
    - "RemoteRegistry"        # Registro remoto (riesgo de seguridad)
    - "Browser"               # Explorador de equipos (NetBIOS)
  ignore_errors: true
  tags:
    - servicios
    - seguridad

# =========================================
# VALIDACI√ìN DE CONFIGURACI√ìN
# =========================================

- name: "‚úÖ Verificar estado del Windows Defender"
  ansible.windows.win_shell: |
    $status = Get-MpComputerStatus
    $result = @{
        AntivirusEnabled = $status.AntivirusEnabled
        RealTimeProtectionEnabled = $status.RealTimeProtectionEnabled
        FirewallEnabled = $status.FirewallEnabled
        SignatureVersion = $status.AntivirusSignatureVersion
        LastUpdated = $status.AntivirusSignatureLastUpdated
    }
    $result | ConvertTo-Json -Compress
  register: defender_status
  tags:
    - validacion
    - antivirus

- name: "üîç Verificar estado del firewall"
  ansible.windows.win_shell: |
    netsh advfirewall show allprofiles | findstr "State"
  register: firewall_status
  changed_when: false
  tags:
    - validacion
    - firewall

- name: "üåê Verificar configuraci√≥n de red"
  ansible.windows.win_shell: |
    Get-NetIPAddress | Where-Object {$_.AddressFamily -eq "IPv6" -and $_.IPAddress -notlike "fe80:*" -and $_.IPAddress -notlike "::1"} | Select-Object IPAddress,InterfaceAlias | ConvertTo-Json -Compress
  register: ipv6_status
  changed_when: false
  tags:
    - validacion
    - red

- name: "üìä Mostrar resumen de configuraci√≥n Windows"
  ansible.builtin.debug:
    msg:
      - "‚úÖ Configuraci√≥n de seguridad Windows completada"
      - "üî• Windows Firewall: {{ 'ACTIVO' if 'ON' in firewall_status.stdout else 'REVISAR' }}"
      - "ü¶† Windows Defender: {{ 'ACTIVO' if 'true' in defender_status.stdout else 'REVISAR' }}"
      - "üåê IPv6: {{ 'CONFIGURADO' if ipv6_status.stdout != '' else 'DHCPv6 en progreso' }}"
      - "üìã Puertos permitidos: SSH(22), WinRM(5985/5986), HTTP(80), HTTPS(443)"
      - "üö´ Puertos bloqueados: Telnet(23), FTP(21), SMB(445), SNMP(161)"
      - "üîí Servicios innecesarios: Deshabilitados"
      - "üõ°Ô∏è  AutoRun/AutoPlay: Deshabilitado"
  tags:
    - validacion
    - resumen