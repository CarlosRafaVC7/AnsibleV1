---
# =========================================
# ROL: seguridad_firewall
# PROPÃ“SITO: ConfiguraciÃ³n completa de firewall, antivirus y red
# COMPATIBLE: Linux (Ubuntu/Mint) y Windows (11 Pro)
# =========================================

- name: "ğŸ”¥ INICIANDO CONFIGURACIÃ“N DE SEGURIDAD Y FIREWALL"
  ansible.builtin.debug:
    msg:
      - "=============================================="
      - "ğŸ”¥ ROL: SEGURIDAD FIREWALL Y ANTIVIRUS"
      - "=============================================="
      - "ğŸ“‹ Host: {{ inventory_hostname }}"
      - "ğŸ–¥ï¸  Sistema: {{ ansible_system | default('Unknown') }}"
      - "ğŸŒ IP Actual: {{ ansible_default_ipv4.address | default('DHCPv6') }}"
      - "ğŸ“… Fecha: {{ ansible_date_time.date }}"
      - "â° Hora: {{ ansible_date_time.time }}"
      - "=============================================="

# =========================================
# TAREAS ESPECÃFICAS POR SISTEMA OPERATIVO
# =========================================

# ConfiguraciÃ³n para sistemas Linux (Ubuntu/Mint)
- name: "ğŸ§ Ejecutar configuraciÃ³n de seguridad Linux"
  include_tasks: linux_firewall.yml
  when: 
    - ansible_os_family == "Debian" or ansible_distribution == "Ubuntu"
  tags:
    - firewall
    - linux
    - seguridad
    - antivirus

# ConfiguraciÃ³n para sistemas Windows
- name: "ğŸªŸ Ejecutar configuraciÃ³n de seguridad Windows"
  include_tasks: windows_firewall.yml
  when: 
    - ansible_os_family == "Windows"
  tags:
    - firewall
    - windows
    - seguridad
    - antivirus

# =========================================
# CONFIGURACIÃ“N DE RED COMÃšN (DHCPv6)
# =========================================

- name: "ğŸŒ Configurar red DHCPv6 y conectividad"
  include_tasks: network_config.yml
  tags:
    - red
    - dhcpv6
    - conectividad

# =========================================
# VALIDACIÃ“N FINAL Y PRUEBAS
# =========================================

- name: "âœ… VALIDACIÃ“N FINAL DE SEGURIDAD"
  block:
    - name: "ğŸ” Verificar estado del firewall"
      ansible.builtin.shell: |
        {% if ansible_os_family == "Debian" or ansible_distribution == "Ubuntu" %}
        ufw status verbose
        {% elif ansible_os_family == "Windows" %}
        netsh advfirewall show allprofiles | findstr "State"
        {% endif %}
      register: firewall_status
      changed_when: false
      ignore_errors: true

    - name: "ğŸ¦  Verificar estado del antivirus"
      ansible.builtin.shell: |
        {% if ansible_os_family == "Debian" or ansible_distribution == "Ubuntu" %}
        systemctl is-active clamav-daemon || echo "ClamAV no activo"
        {% elif ansible_os_family == "Windows" %}
        Get-MpComputerStatus | Select-Object AntivirusEnabled,RealTimeProtectionEnabled | ConvertTo-Json -Compress
        {% endif %}
      register: antivirus_status
      changed_when: false
      ignore_errors: true

    - name: "ğŸŒ Verificar configuraciÃ³n de red"
      ansible.builtin.shell: |
        {% if ansible_os_family == "Debian" or ansible_distribution == "Ubuntu" %}
        ip addr show | grep -E "(inet6|inet)" | head -5
        {% elif ansible_os_family == "Windows" %}
        Get-NetIPAddress | Where-Object {$_.AddressFamily -eq "IPv6" -or $_.AddressFamily -eq "IPv4"} | Select-Object IPAddress,InterfaceAlias | ConvertTo-Json -Compress
        {% endif %}
      register: network_status
      changed_when: false
      ignore_errors: true

    - name: "ğŸ“Š MOSTRAR RESUMEN FINAL DE SEGURIDAD"
      ansible.builtin.debug:
        msg:
          - "=================== RESUMEN FINAL DE SEGURIDAD ==================="
          - "âœ… ConfiguraciÃ³n completada en: {{ inventory_hostname }}"
          - "ğŸ–¥ï¸  Sistema: {{ ansible_system }} {{ ansible_distribution | default('') }}"
          - "ğŸ”¥ Firewall: {{ 'ACTIVO' if firewall_status.rc == 0 else 'REVISAR' }}"
          - "ğŸ¦  Antivirus: {{ 'ACTIVO' if antivirus_status.rc == 0 else 'REVISAR' }}"
          - "ğŸŒ Red: {{ 'CONFIGURADA' if network_status.rc == 0 else 'REVISAR' }}"
          - "ğŸ›¡ï¸  Fail2ban: {{ 'ACTIVO (Linux)' if ansible_os_family == 'Debian' else 'N/A (Windows)' }}"
          - "ğŸ“‹ Puertos seguros: SSH(22), HTTP(80), HTTPS(443)"
          - "ğŸš« PolÃ­tica por defecto: DENEGAR TODO excepto permitidos"
          - "â° ConfiguraciÃ³n finalizada: {{ ansible_date_time.iso8601 }}"
          - "================================================================="

  tags:
    - validation
    - resumen