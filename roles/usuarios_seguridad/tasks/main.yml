---
# =========================================
# ROL: usuarios_seguridad
# PROPÃ“SITO: GestiÃ³n completa de usuarios, grupos y polÃ­ticas de seguridad
# COMPATIBLE: Linux (Ubuntu/Mint) y Windows (11 Pro)
# =========================================

- name: "ğŸ” INICIANDO CONFIGURACIÃ“N DE USUARIOS Y SEGURIDAD"
  ansible.builtin.debug:
    msg:
      - "=============================================="
      - "ğŸ” ROL: USUARIOS Y SEGURIDAD DE LABORATORIO"
      - "=============================================="
      - "ğŸ“‹ Host: {{ inventory_hostname }}"
      - "ğŸ–¥ï¸  Sistema: {{ ansible_system | default('Unknown') }}"
      - "ğŸ“… Fecha: {{ ansible_date_time.date }}"
      - "â° Hora: {{ ansible_date_time.time }}"
      - "=============================================="

# =========================================
# TAREAS ESPECÃFICAS POR SISTEMA OPERATIVO
# =========================================

# Incluir tareas para sistemas Linux (Ubuntu/Mint)
- name: "ğŸ§ Ejecutar configuraciÃ³n para sistemas Linux"
  include_tasks: linux_usuarios.yml
  when: 
    - ansible_os_family == "Debian" or ansible_distribution == "Ubuntu"
  tags:
    - usuarios
    - linux
    - seguridad

# Incluir tareas para sistemas Windows
- name: "ğŸªŸ Ejecutar configuraciÃ³n para sistemas Windows"
  include_tasks: windows_usuarios.yml
  when: 
    - ansible_os_family == "Windows"
  tags:
    - usuarios
    - windows
    - seguridad

# =========================================
# VALIDACIÃ“N FINAL
# =========================================

- name: "âœ… VALIDACIÃ“N FINAL DE CONFIGURACIÃ“N"
  block:
    - name: "ğŸ“Š Verificar usuarios creados en Linux"
      ansible.builtin.getent:
        database: passwd
        key: "{{ item.username }}"
      loop: "{{ lab_usuarios }}"
      when: 
        - ansible_os_family == "Debian" or ansible_distribution == "Ubuntu"
        - lab_usuarios is defined
      register: linux_users_validation
      ignore_errors: yes

    - name: "ğŸ“Š Verificar usuarios creados en Windows"
      ansible.windows.win_shell: |
        Get-LocalUser -Name "{{ item.username }}" | Select-Object Name,Enabled,LastLogon | ConvertTo-Json
      loop: "{{ lab_usuarios }}"
      when: 
        - ansible_os_family == "Windows"
        - lab_usuarios is defined
      register: windows_users_validation
      ignore_errors: yes

    - name: "ğŸ“ˆ Mostrar resumen final de configuraciÃ³n"
      ansible.builtin.debug:
        msg:
          - "=================== RESUMEN FINAL ==================="
          - "âœ… ConfiguraciÃ³n de usuarios completada exitosamente"
          - "ğŸ“‹ Host configurado: {{ inventory_hostname }}"
          - "ğŸ–¥ï¸  Sistema operativo: {{ ansible_system }}"
          - "ğŸ‘¥ Usuarios configurados: {{ lab_usuarios | length if lab_usuarios is defined else 0 }}"
          - "ğŸ”’ Grupos de seguridad: {{ lab_grupos | length if lab_grupos is defined else 0 }}"
          - "ğŸ›¡ï¸  PolÃ­ticas aplicadas: âœ… ContraseÃ±as, âœ… Sudo, âœ… Seguridad"
          - "â° ConfiguraciÃ³n completada: {{ ansible_date_time.iso8601 }}"
          - "=================================================="

  tags:
    - validation
    - usuarios
    - resumen