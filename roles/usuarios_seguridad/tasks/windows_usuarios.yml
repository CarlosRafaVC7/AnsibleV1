---
# =========================================
# CONFIGURACI√ìN DE USUARIOS Y SEGURIDAD - WINDOWS
# Sistema: Windows 11 Pro
# Prop√≥sito: Crear usuarios de laboratorio con pol√≠ticas de seguridad
# =========================================

- name: "ü™ü INICIANDO CONFIGURACI√ìN WINDOWS"
  ansible.builtin.debug:
    msg:
      - "ü™ü Configurando usuarios y seguridad en sistema Windows"
      - "üìã Sistema: {{ ansible_system }} {{ ansible_distribution }}"
      - "üîß Versi√≥n: {{ ansible_distribution_version }}"

# =========================================
# CREACI√ìN DE GRUPOS DE LABORATORIO
# =========================================

- name: "üë• Crear grupos espec√≠ficos del laboratorio en Windows"
  ansible.windows.win_group:
    name: "{{ item.name }}"
    description: "{{ item.description | default('Grupo de laboratorio') }}"
    state: present
  loop: "{{ lab_grupos }}"
  tags:
    - grupos
    - windows

# =========================================
# CREACI√ìN DE USUARIOS CON CONFIGURACI√ìN ESPEC√çFICA
# =========================================

- name: "üë§ Crear usuarios del laboratorio en Windows"
  ansible.windows.win_user:
    name: "{{ item.username }}"
    fullname: "{{ item.fullname }}"
    password: "{{ item.password }}"
    groups: "{{ item.groups }}"
    password_never_expires: "{{ item.password_never_expires | default(false) }}"
    user_cannot_change_password: "{{ item.user_cannot_change_password | default(false) }}"
    password_expired: false
    state: present
  loop: "{{ lab_usuarios }}"
  no_log: true  # Ocultar contrase√±as en logs por seguridad
  tags:
    - usuarios
    - windows

# =========================================
# CONFIGURACI√ìN DE POL√çTICAS DE CONTRASE√ëAS
# =========================================

- name: "üîê Configurar pol√≠ticas de contrase√±as en Windows"
  ansible.windows.win_shell: |
    # Configurar pol√≠tica de contrase√±as local
    net accounts /minpwlen:8        # M√≠nimo 8 caracteres
    net accounts /maxpwage:90       # M√°ximo 90 d√≠as
    net accounts /minpwage:1        # M√≠nimo 1 d√≠a entre cambios
    net accounts /uniquepw:5        # Recordar √∫ltimas 5 contrase√±as
    
    # Configurar pol√≠tica de bloqueo
    net accounts /lockoutthreshold:5    # 5 intentos fallidos
    net accounts /lockoutduration:30    # Bloqueo por 30 minutos
    net accounts /lockoutwindow:30      # Ventana de 30 minutos
  tags:
    - contrase√±as
    - politicas
    - seguridad

- name: "üõ°Ô∏è Habilitar complejidad de contrase√±as"
  ansible.windows.win_security_policy:
    section: "System Access"
    key: "PasswordComplexity" 
    value: "1"  # Habilitar complejidad
  tags:
    - contrase√±as
    - seguridad

# =========================================
# CONFIGURACI√ìN UAC (CONTROL DE CUENTAS DE USUARIO)
# =========================================

- name: "üîí Configurar UAC (Control de Cuentas de Usuario)"
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: "{{ item.name }}"
    data: "{{ item.value }}"
    type: dword
  loop:
    - { name: "EnableLUA", value: 1 }                    # Habilitar UAC
    - { name: "ConsentPromptBehaviorAdmin", value: 2 }   # Prompt para administradores
    - { name: "ConsentPromptBehaviorUser", value: 3 }    # Prompt para usuarios est√°ndar
    - { name: "PromptOnSecureDesktop", value: 1 }        # Usar escritorio seguro
  tags:
    - uac
    - seguridad

# =========================================
# DESHABILITAR CUENTAS DE SISTEMA PELIGROSAS
# =========================================

- name: "üö´ Deshabilitar cuenta Guest"
  ansible.windows.win_user:
    name: "Guest"
    account_disabled: true
  ignore_errors: true
  tags:
    - seguridad
    - guest

- name: "üö´ Deshabilitar cuenta Administrator por defecto"
  ansible.windows.win_user:
    name: "Administrator"
    account_disabled: true
  ignore_errors: true
  tags:
    - seguridad
    - administrator

# =========================================
# CONFIGURACI√ìN DE AUDITOR√çA
# =========================================

- name: "üìã Configurar pol√≠ticas de auditor√≠a en Windows"
  ansible.windows.win_security_policy:
    section: "Event Audit"
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  loop:
    - { key: "AuditSystemEvents", value: "3" }        # Auditar eventos del sistema
    - { key: "AuditLogonEvents", value: "3" }         # Auditar inicios de sesi√≥n
    - { key: "AuditObjectAccess", value: "1" }        # Auditar acceso a objetos
    - { key: "AuditPolicyChange", value: "3" }        # Auditar cambios de pol√≠ticas
    - { key: "AuditAccountManage", value: "3" }       # Auditar gesti√≥n de cuentas
  tags:
    - auditoria
    - seguridad

- name: "üìä Expandir tama√±o de logs de seguridad"
  ansible.windows.win_shell: |
    wevtutil sl Security /ms:1048576      # 1MB para log de seguridad
    wevtutil sl Application /ms:1048576   # 1MB para log de aplicaci√≥n
    wevtutil sl System /ms:1048576        # 1MB para log del sistema
  tags:
    - logging
    - auditoria

# =========================================
# CONFIGURACI√ìN DE PRIVILEGIOS LOCALES
# =========================================

- name: "‚öôÔ∏è Configurar privilegios de usuarios"
  ansible.windows.win_shell: |
    # Configurar privilegios para usuarios espec√≠ficos
    {% for usuario in lab_usuarios %}
    {% if usuario.sudo_config == 'full' %}
    # {{ usuario.username }} - Privilegios administrativos completos
    net localgroup "Administradores" "{{ usuario.username }}" /add
    {% elif usuario.sudo_config == 'limited' %}
    # {{ usuario.username }} - Privilegios limitados
    net localgroup "Usuarios avanzados" "{{ usuario.username }}" /add
    {% elif usuario.sudo_config == 'web_service' %}
    # {{ usuario.username }} - Solo servicios web
    net localgroup "Usuarios de IIS_IUSRS" "{{ usuario.username }}" /add
    {% endif %}
    {% endfor %}
  ignore_errors: true
  tags:
    - privilegios
    - usuarios

# =========================================
# CONFIGURACI√ìN DE FIREWALL DE WINDOWS
# =========================================

- name: "üî• Habilitar Windows Firewall en todos los perfiles"
  ansible.windows.win_firewall:
    state: enabled
    profiles:
      - domain
      - private 
      - public
  tags:
    - firewall
    - seguridad

# =========================================
# DESHABILITACI√ìN DE SERVICIOS INNECESARIOS
# =========================================

- name: "üö´ Deshabilitar servicios innecesarios"
  ansible.windows.win_service:
    name: "{{ item }}"
    state: stopped
    start_mode: disabled
  loop:
    - "Fax"                    # Servicio de fax
    - "TapiSrv"               # Telefon√≠a
    - "Telnet"                # Telnet inseguro
    - "RemoteRegistry"        # Registro remoto
    - "Browser"               # Explorador de equipos
  ignore_errors: true
  tags:
    - servicios
    - seguridad

# =========================================
# CONFIGURACI√ìN DE ACTUALIZACIONES AUTOM√ÅTICAS
# =========================================

- name: "üîÑ Configurar Windows Update"
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
    name: "{{ item.name }}"
    data: "{{ item.value }}"
    type: dword
  loop:
    - { name: "NoAutoUpdate", value: 0 }              # Habilitar actualizaciones autom√°ticas
    - { name: "AUOptions", value: 4 }                 # Descargar e instalar autom√°ticamente
    - { name: "ScheduledInstallDay", value: 0 }       # Todos los d√≠as
    - { name: "ScheduledInstallTime", value: 3 }      # 3 AM
  tags:
    - actualizaciones
    - seguridad

# =========================================
# VALIDACI√ìN DE CONFIGURACI√ìN
# =========================================

- name: "‚úÖ Verificar que los usuarios fueron creados correctamente"
  ansible.windows.win_shell: |
    Get-LocalUser -Name "{{ item.username }}" | Select-Object Name,Enabled,LastLogon | ConvertTo-Json
  loop: "{{ lab_usuarios }}"
  register: user_validation_windows
  tags:
    - validacion
    - usuarios

- name: "üìä Mostrar informaci√≥n de usuarios creados en Windows"
  ansible.builtin.debug:
    msg:
      - "‚úÖ Usuario {{ item.item.username }} verificado en Windows"
      - "üë• Grupos: {{ item.item.groups | join(', ') }}"
      - "üîß Configuraci√≥n: {{ item.item.sudo_config | default('est√°ndar') }}"
      - "üîí Estado UAC: Habilitado"
  loop: "{{ user_validation_windows.results }}"
  when: user_validation_windows is defined
  tags:
    - validacion
    - info