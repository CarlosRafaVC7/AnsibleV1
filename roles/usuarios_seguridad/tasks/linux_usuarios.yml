---
# =========================================
# CONFIGURACIÃ“N DE USUARIOS Y SEGURIDAD - LINUX
# Sistema: Ubuntu/Mint
# PropÃ³sito: Crear usuarios de laboratorio con polÃ­ticas de seguridad
# =========================================

- name: "ğŸ§ INICIANDO CONFIGURACIÃ“N LINUX"
  ansible.builtin.debug:
    msg:
      - "ğŸ§ Configurando usuarios y seguridad en sistema Linux"
      - "ğŸ“‹ DistribuciÃ³n: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - "ğŸ”§ Arquitectura: {{ ansible_architecture }}"

# =========================================
# INSTALACIÃ“N DE PAQUETES NECESARIOS
# =========================================

- name: "ğŸ“¦ Instalar paquetes necesarios para gestiÃ³n de usuarios"
  ansible.builtin.apt:
    name:
      - passwd          # GestiÃ³n de contraseÃ±as
      - sudo           # Privilegios administrativos
      - adduser        # CreaciÃ³n de usuarios
      - libpam-pwquality  # PolÃ­ticas de contraseÃ±as
      - cron           # Tareas programadas
    state: present
    update_cache: true
  become: true
  tags:
    - paquetes
    - seguridad

# =========================================
# CREACIÃ“N DE GRUPOS DE LABORATORIO
# =========================================

- name: "ğŸ‘¥ Crear grupos especÃ­ficos del laboratorio"
  ansible.builtin.group:
    name: "{{ item.name }}"
    gid: "{{ item.gid | default(omit) }}"
    state: present
  loop: "{{ lab_grupos }}"
  become: true
  tags:
    - grupos

# =========================================
# CREACIÃ“N DE USUARIOS CON CONFIGURACIÃ“N ESPECÃFICA
# =========================================

- name: "ğŸ‘¤ Crear usuarios del laboratorio"
  ansible.builtin.user:
    name: "{{ item.username }}"
    comment: "{{ item.fullname }}"
    groups: "{{ item.groups | join(',') }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    password: "{{ item.password | password_hash('sha512') }}"
    create_home: yes
    home: "/home/{{ item.username }}"
    state: present
    # Configurar expiraciÃ³n de contraseÃ±a (90 dÃ­as)
    password_expire_max: 90
  loop: "{{ lab_usuarios }}"
  become: true
  no_log: true  # Ocultar contraseÃ±as en logs por seguridad
  tags:
    - usuarios

# =========================================
# CONFIGURACIÃ“N DE PERMISOS DE DIRECTORIOS HOME
# =========================================

- name: "ğŸ  Configurar permisos de directorios home"
  ansible.builtin.file:
    path: "/home/{{ item.username }}"
    mode: "{{ item.home_permissions | default('0755') }}"
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
  loop: "{{ lab_usuarios }}"
  become: true
  tags:
    - permisos
    - usuarios

# =========================================
# CONFIGURACIÃ“N DE SUDO PERSONALIZADA
# =========================================

- name: "âš™ï¸ Configurar sudoers personalizado desde plantilla"
  ansible.builtin.template:
    src: sudoers_lab.j2
    dest: "/etc/sudoers.d/lab_users"
    mode: "0440"
    owner: root
    group: root
    validate: '/usr/sbin/visudo -cf %s'  # Validar sintaxis antes de aplicar
  become: true
  tags:
    - sudo
    - seguridad

- name: "ğŸ›¡ï¸ Configurar sudo individual para usuarios especÃ­ficos"
  ansible.builtin.template:
    src: sudoers_individual.j2
    dest: "/etc/sudoers.d/{{ item.username }}"
    mode: "0440"
    owner: root
    group: root
    validate: '/usr/sbin/visudo -cf %s'
  loop: "{{ lab_usuarios }}"
  when: 
    - item.sudo_config is defined
    - item.sudo_config != "none"
  become: true
  tags:
    - sudo
    - usuarios

# =========================================
# POLÃTICAS DE CONTRASEÃ‘AS SEGURAS
# =========================================

- name: "ğŸ” Configurar polÃ­ticas de contraseÃ±as seguras"
  ansible.builtin.template:
    src: pwquality.conf.j2
    dest: "/etc/security/pwquality.conf"
    backup: yes
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: restart_pam_services
  tags:
    - contraseÃ±as
    - seguridad

- name: "â° Configurar expiraciÃ³n de contraseÃ±as en login.defs"
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: "^{{ item.param }}"
    line: "{{ item.param }}	{{ item.value }}"
    backup: yes
  loop:
    - { param: "PASS_MAX_DAYS", value: "90" }     # MÃ¡ximo 90 dÃ­as
    - { param: "PASS_MIN_DAYS", value: "1" }      # MÃ­nimo 1 dÃ­a entre cambios
    - { param: "PASS_WARN_AGE", value: "7" }      # Advertir 7 dÃ­as antes
    - { param: "PASS_MIN_LEN", value: "8" }       # MÃ­nimo 8 caracteres
  become: true
  tags:
    - contraseÃ±as
    - politicas

# =========================================
# DESHABILITAR CUENTAS DE SISTEMA PELIGROSAS
# =========================================

- name: "ğŸš« Deshabilitar cuenta root para login SSH"
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PermitRootLogin"
    line: "PermitRootLogin no"
    backup: true
  become: true
  notify: restart_ssh
  tags:
    - ssh
    - seguridad

- name: "ğŸ”’ Bloquear cuenta root (mantener solo para sudo)"
  ansible.builtin.user:
    name: root
    password_lock: true  # Bloquear password pero mantener cuenta
  become: true
  tags:
    - seguridad
    - root

- name: "ğŸš« Deshabilitar cuenta guest (si existe)"
  ansible.builtin.user:
    name: guest
    state: absent
    remove: true
  become: true
  ignore_errors: true  # Puede que no exista
  tags:
    - seguridad
    - guest

# =========================================
# CONFIGURACIÃ“N DE LIMITES DE SISTEMA
# =========================================

- name: "ğŸ“Š Configurar lÃ­mites de sistema para usuarios"
  ansible.builtin.template:
    src: limits.conf.j2
    dest: "/etc/security/limits.d/lab_users.conf"
    owner: root
    group: root
    mode: "0644"
  become: true
  tags:
    - limites
    - seguridad

# =========================================
# AUDITORÃA Y LOGGING
# =========================================

- name: "ğŸ“‹ Configurar logging de actividades de usuario"
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-session
    line: "session required pam_exec.so /usr/local/bin/log_user_activity.sh"
    insertafter: "session.*pam_unix.so"
  become: true
  tags:
    - auditoria
    - logging

- name: "ğŸ“ Crear script de logging de actividades"
  ansible.builtin.template:
    src: log_user_activity.sh.j2
    dest: "/usr/local/bin/log_user_activity.sh"
    mode: "0755"
    owner: root
    group: root
  become: true
  tags:
    - auditoria
    - scripts

# =========================================
# VALIDACIÃ“N DE CONFIGURACIÃ“N
# =========================================

- name: "âœ… Verificar que los usuarios fueron creados correctamente"
  ansible.builtin.command: id {{ item.username }}
  loop: "{{ lab_usuarios }}"
  register: user_validation
  changed_when: false
  failed_when: user_validation.rc != 0
  become: true
  tags:
    - validacion

- name: "ğŸ“Š Mostrar informaciÃ³n de usuarios creados"
  ansible.builtin.debug:
    msg:
      - "âœ… Usuario {{ item.item.username }} creado exitosamente"
      - "ğŸ†” ID: {{ item.stdout }}"
      - "ğŸ‘¥ Grupos: {{ item.item.groups | join(', ') }}"
      - "ğŸ”§ ConfiguraciÃ³n sudo: {{ item.item.sudo_config | default('ninguna') }}"
  loop: "{{ user_validation.results }}"
  when: user_validation is defined
  tags:
    - validacion
    - info