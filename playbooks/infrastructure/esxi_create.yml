---
# Playbook para crear VMs completas en VMware ESXi
# Basado en mejores prÃ¡cticas: crea VM, monta ISO, enciende
# Listo para instalaciÃ³n manual de sistemas operativos

- name: Crear VMs funcionales en infraestructura ESXi
  hosts: localhost
  gather_facts: no
  collections: 
    - community.vmware
  vars:
    esxi_host: "168.121.48.254:10121"
    esxi_user: "root"
    esxi_pass: "qwe123$"
    esxi_hostname_fqdn: "localhost.lim.upeu.edu.pe"
    datacenter_name: "ha-datacenter"
    
    # ConfiguraciÃ³n del datastore
    datastore_name: "datastore1"
    vm_network: "VM Network"
    
    # ISOs en el datastore (actualizar segÃºn disponibilidad)
    ubuntu_iso_path: "[datastore1] ubuntu-24.04.3-live-server-amd64.iso"
    windows_iso_path: "[datastore1] Win11_24H2_Spanish_x64.iso"
    
    # ConfiguraciÃ³n de VMs
    vm_ubuntu_name: "Ubuntu-Academico"
    vm_ubuntu_memory: 4096
    vm_ubuntu_cpus: 2
    vm_ubuntu_disk: 40

    vm_windows_name: "Windows-Gamer"
    vm_windows_memory: 8192
    vm_windows_cpus: 4
    vm_windows_disk: 80

    # Opciones de creaciÃ³n
    create_vm_academico: true
    create_vm_gamer: true
    mount_isos: true          # Nuevo: montar ISOs automÃ¡ticamente
    power_on_vms: true        # Nuevo: encender VMs al final
    
  pre_tasks:
    - name: Verificar que las variables ESXi estÃ©n definidas
      ansible.builtin.assert:
        that:
          - esxi_host is defined
          - esxi_user is defined
          - esxi_pass is defined
        fail_msg: "Configure las variables ESXi antes de ejecutar"
        
    - name: Informar sobre el proceso mejorado
      ansible.builtin.debug:
        msg:
          - "ğŸš€ CREACIÃ“N COMPLETA DE VMs EN ESXi"
          - "ğŸ“¡ Host: {{ esxi_host }}"
          - "ğŸ’¾ Datastore: {{ datastore_name }}"
          - "ğŸŒ Red: {{ vm_network }}"
          - "ï¿½ Montaje ISO: {{ 'Habilitado' if mount_isos else 'Deshabilitado' }}"
          - "âš¡ Encendido automÃ¡tico: {{ 'SÃ­' if power_on_vms else 'No' }}"
        
  roles:
    - infrastructure
    
  post_tasks:
    - name: Instrucciones post-creaciÃ³n actualizadas
      ansible.builtin.debug:
        msg:
          - "âœ… VMs COMPLETAS CREADAS EN ESXi {{ esxi_host }}"
          - ""
          - "ï¿½ï¸  ESTADO DE LAS VMs:"
          - "   â€¢ {{ vm_ubuntu_name }}: {{ vm_ubuntu_memory }}MB, {{ vm_ubuntu_cpus }} CPU, {{ vm_ubuntu_disk }}GB"
          - "   â€¢ {{ vm_windows_name }}: {{ vm_windows_memory }}MB, {{ vm_windows_cpus }} CPU, {{ vm_windows_disk }}GB"
          - ""
          - "ğŸ“‹ PRÃ“XIMOS PASOS:"
          - "1. ğŸŒ Acceder a ESXi Host Client: https://{{ esxi_host.split(':')[0] }}:443"
          - "2. ğŸ“€ VMs encendidas con ISOs montados - listas para instalar OS"
          - "3. ğŸ“– Seguir guÃ­a: docs/INSTALACION_MANUAL.md"
          - "4. ğŸ”Œ Configurar red y SSH/WinRM en cada VM"
          - "5. ğŸ“ Actualizar inventory/hosts.ini con IPs reales"
          - "6. ğŸ¯ Ejecutar: ansible-playbook playbooks/main.yml"
          - ""
          - "âœ¨ Las VMs estÃ¡n listas para instalaciÃ³n manual de OS"