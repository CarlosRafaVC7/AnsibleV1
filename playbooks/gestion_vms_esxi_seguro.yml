---
# Playbook para gesti√≥n segura de VMs en ESXi
# Incluye logging de seguridad y trazabilidad completa

- hosts: localhost
  gather_facts: no
  collections: [community.vmware]

  vars:
    # Configuraci√≥n ESXi con credenciales del vault
    esxi_host: "168.121.48.254:10113"
    esxi_user: "{{ vault_esxi_username | default('root') }}"
    esxi_pass: "{{ vault_esxi_password }}"
    ds_name: "datastore1"
    esxi_hostname_fqdn: "localhost.lim.upeu.edu.pe"
    
    # Configuraci√≥n de VMs del proyecto
    linux_vm_name: "linux-mint-academico"
    windows_vm_name: "windows-gaming-lab"
    
    # ISOs disponibles
    linux_iso_path: "[datastore1] linuxmint-21.3-cinnamon-64bit.iso"
    windows_iso_path: "[datastore1] windows-11-pro.iso"
    
    # Red y seguridad
    portgroup: "VM Network"
    security_log_path: "/var/log/ansible_monitor/esxi_operations.log"

  tasks:
    # ==========================================
    # LOGGING DE SEGURIDAD - Al inicio
    # ==========================================
    - name: "üîí Registrar inicio de operaciones ESXi"
      ansible.builtin.lineinfile:
        path: "{{ security_log_path }}"
        line: "{{ ansible_date_time.iso8601 }} - INICIO: Operaciones ESXi por usuario {{ ansible_user_id }}"
        create: yes
      delegate_to: localhost

    - name: "üìã Mostrar configuraci√≥n de seguridad inicial"
      ansible.builtin.debug:
        msg:
          - "============================================="
          - "üîí OPERACIONES SEGURAS EN ESXI"
          - "============================================="
          - "ESXi Host: {{ esxi_host }}"
          - "Usuario: {{ esxi_user }}"
          - "Datastore: {{ ds_name }}"
          - "Portgroup: {{ portgroup }}"
          - "Timestamp: {{ ansible_date_time.iso8601 }}"
          - "============================================="

    # ==========================================
    # CREACI√ìN VM LINUX ACAD√âMICO
    # ==========================================
    - name: "üêß Crear VM Linux Mint (Laboratorio Acad√©mico)"
      community.vmware.vmware_guest:
        hostname: "{{ esxi_host }}"
        username: "{{ esxi_user }}"
        password: "{{ esxi_pass }}"
        validate_certs: no
        esxi_hostname: "{{ esxi_hostname_fqdn }}"
        folder: "/Laboratorios"
        name: "{{ linux_vm_name }}"
        state: present
        guest_id: "ubuntu64Guest"
        datastore: "{{ ds_name }}"
        hardware:
          memory_mb: 4096
          num_cpus: 2
          scsi: paravirtual
        disk:
          - size_gb: 40
            type: thin
            datastore: "{{ ds_name }}"
        networks:
          - name: "{{ portgroup }}"
            start_connected: true
            device_type: vmxnet3
        wait_for_ip_address: no
        state_change_timeout: 180
      register: linux_vm_result

    - name: "üîí Registrar creaci√≥n VM Linux"
      ansible.builtin.lineinfile:
        path: "{{ security_log_path }}"
        line: "{{ ansible_date_time.iso8601 }} - CREACI√ìN: VM Linux {{ linux_vm_name }} - Estado: {{ linux_vm_result.changed | ternary('CREADA', 'YA_EXIST√çA') }}"
      delegate_to: localhost

    # ==========================================
    # CREACI√ìN VM WINDOWS GAMING
    # ==========================================
    - name: "üéÆ Crear VM Windows (Laboratorio Gaming)"
      community.vmware.vmware_guest:
        hostname: "{{ esxi_host }}"
        username: "{{ esxi_user }}"
        password: "{{ esxi_pass }}"
        validate_certs: no
        esxi_hostname: "{{ esxi_hostname_fqdn }}"
        folder: "/Laboratorios"
        name: "{{ windows_vm_name }}"
        state: present
        guest_id: "windows9_64Guest"
        datastore: "{{ ds_name }}"
        hardware:
          memory_mb: 8192
          num_cpus: 4
          scsi: paravirtual
        disk:
          - size_gb: 80
            type: thin
            datastore: "{{ ds_name }}"
        networks:
          - name: "{{ portgroup }}"
            start_connected: true
            device_type: vmxnet3
        wait_for_ip_address: no
        state_change_timeout: 180
      register: windows_vm_result

    - name: "üîí Registrar creaci√≥n VM Windows"
      ansible.builtin.lineinfile:
        path: "{{ security_log_path }}"
        line: "{{ ansible_date_time.iso8601 }} - CREACI√ìN: VM Windows {{ windows_vm_name }} - Estado: {{ windows_vm_result.changed | ternary('CREADA', 'YA_EXIST√çA') }}"
      delegate_to: localhost

    # ==========================================
    # CONFIGURACI√ìN DE SEGURIDAD EN VMs
    # ==========================================
    - name: "üîí Obtener informaci√≥n detallada de VM Linux"
      community.vmware.vmware_guest_info:
        hostname: "{{ esxi_host }}"
        username: "{{ esxi_user }}"
        password: "{{ esxi_pass }}"
        validate_certs: no
        name: "{{ linux_vm_name }}"
      register: linux_vm_info

    - name: "üîí Obtener informaci√≥n detallada de VM Windows"
      community.vmware.vmware_guest_info:
        hostname: "{{ esxi_host }}"
        username: "{{ esxi_user }}"
        password: "{{ esxi_pass }}"
        validate_certs: no
        name: "{{ windows_vm_name }}"
      register: windows_vm_info

    # ==========================================
    # LOGGING DE SEGURIDAD - Informaci√≥n detallada
    # ==========================================
    - name: "üìä Mostrar configuraci√≥n de seguridad VM Linux"
      ansible.builtin.debug:
        msg:
          - "=============== VM LINUX ACAD√âMICO ==============="
          - "Nombre: {{ linux_vm_name }}"
          - "Estado: {{ linux_vm_info.instance.hw_power_status }}"
          - "IP: {{ linux_vm_info.instance.ipv4 | default('Pendiente') }}"
          - "MAC: {{ linux_vm_info.instance.hw_eth0.macaddress | default('N/A') }}"
          - "CPU: {{ linux_vm_info.instance.hw_processor_count }}"
          - "RAM: {{ linux_vm_info.instance.hw_memtotal_mb }} MB"
          - "Discos: {{ linux_vm_info.instance.hw_files | length }} archivo(s)"
          - "NICs: {{ linux_vm_info.instance.networks | default([]) | length }}"
          - "=============================================="

    - name: "üìä Mostrar configuraci√≥n de seguridad VM Windows"
      ansible.builtin.debug:
        msg:
          - "=============== VM WINDOWS GAMING ==============="
          - "Nombre: {{ windows_vm_name }}"
          - "Estado: {{ windows_vm_info.instance.hw_power_status }}"
          - "IP: {{ windows_vm_info.instance.ipv4 | default('Pendiente') }}"
          - "MAC: {{ windows_vm_info.instance.hw_eth0.macaddress | default('N/A') }}"
          - "CPU: {{ windows_vm_info.instance.hw_processor_count }}"
          - "RAM: {{ windows_vm_info.instance.hw_memtotal_mb }} MB"
          - "Discos: {{ windows_vm_info.instance.hw_files | length }} archivo(s)"
          - "NICs: {{ windows_vm_info.instance.networks | default([]) | length }}"
          - "=============================================="

    # ==========================================
    # LOGGING COMPLETO DE DISPOSITIVOS (MEDIDA DE SEGURIDAD)
    # ==========================================
    - name: "üîç Auditor√≠a completa de dispositivos VM Linux"
      ansible.builtin.debug:
        msg:
          - "=== AUDITOR√çA DE DISPOSITIVOS LINUX ==="
          - "CD/DVD devices: {{ (linux_vm_info.instance.guest_devices | selectattr('type','equalto','cdrom') | list) | default([]) }}"
          - "Network devices: {{ linux_vm_info.instance.networks | default([]) }}"
          - "Disk devices: {{ linux_vm_info.instance.hw_files | default([]) }}"
          - "USB devices: {{ (linux_vm_info.instance.guest_devices | selectattr('type','equalto','usb') | list) | default([]) }}"

    - name: "üîç Auditor√≠a completa de dispositivos VM Windows"
      ansible.builtin.debug:
        msg:
          - "=== AUDITOR√çA DE DISPOSITIVOS WINDOWS ==="
          - "CD/DVD devices: {{ (windows_vm_info.instance.guest_devices | selectattr('type','equalto','cdrom') | list) | default([]) }}"
          - "Network devices: {{ windows_vm_info.instance.networks | default([]) }}"
          - "Disk devices: {{ windows_vm_info.instance.hw_files | default([]) }}"
          - "USB devices: {{ (windows_vm_info.instance.guest_devices | selectattr('type','equalto','usb') | list) | default([]) }}"

    # ==========================================
    # LOGGING DE SEGURIDAD - Registro completo
    # ==========================================
    - name: "üîí Registrar configuraci√≥n completa de VMs"
      ansible.builtin.blockinfile:
        path: "{{ security_log_path }}"
        marker: "# {mark} ANSIBLE VM AUDIT {{ ansible_date_time.iso8601 }}"
        block: |
          =================== AUDITOR√çA DE SEGURIDAD VMs ===================
          Timestamp: {{ ansible_date_time.iso8601 }}
          Operador: {{ ansible_user_id }}
          ESXi Host: {{ esxi_host }}
          
          === VM LINUX ACAD√âMICO ===
          Nombre: {{ linux_vm_name }}
          Estado: {{ linux_vm_info.instance.hw_power_status }}
          IP: {{ linux_vm_info.instance.ipv4 | default('Pendiente') }}
          MAC: {{ linux_vm_info.instance.hw_eth0.macaddress | default('N/A') }}
          Recursos: {{ linux_vm_info.instance.hw_processor_count }}CPU / {{ linux_vm_info.instance.hw_memtotal_mb }}MB RAM
          
          === VM WINDOWS GAMING ===
          Nombre: {{ windows_vm_name }}
          Estado: {{ windows_vm_info.instance.hw_power_status }}
          IP: {{ windows_vm_info.instance.ipv4 | default('Pendiente') }}
          MAC: {{ windows_vm_info.instance.hw_eth0.macaddress | default('N/A') }}
          Recursos: {{ windows_vm_info.instance.hw_processor_count }}CPU / {{ windows_vm_info.instance.hw_memtotal_mb }}MB RAM
          ================================================================
      delegate_to: localhost

    # ==========================================
    # VERIFICACI√ìN FINAL DE SEGURIDAD
    # ==========================================
    - name: "‚úÖ Resumen final de operaciones de seguridad"
      ansible.builtin.debug:
        msg:
          - "üîí ===== RESUMEN DE SEGURIDAD ====="
          - "‚úÖ Credenciales: Protegidas con Ansible Vault"
          - "‚úÖ Logging: Todas las operaciones registradas"
          - "‚úÖ Auditor√≠a: Dispositivos inventariados"
          - "‚úÖ Trazabilidad: Timestamps completos"
          - "‚úÖ Red: Configuraci√≥n NIC documentada"
          - "‚úÖ Estado: VMs operativas y monitoreadas"
          - "üìÅ Log file: {{ security_log_path }}"
          - "üïí Completado: {{ ansible_date_time.iso8601 }}"
          - "================================="

    - name: "üîí Registrar finalizaci√≥n exitosa"
      ansible.builtin.lineinfile:
        path: "{{ security_log_path }}"
        line: "{{ ansible_date_time.iso8601 }} - COMPLETADO: Todas las operaciones ESXi finalizadas exitosamente - Usuario: {{ ansible_user_id }}"
      delegate_to: localhost