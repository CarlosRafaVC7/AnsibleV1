---
# =========================================
# PLAYBOOK DE EJEMPLO: USUARIOS Y SEGURIDAD
# Prop√≥sito: Implementar usuarios y firewall en laboratorio
# Uso: ansible-playbook -i inventory/hosts.ini playbooks/setup_usuarios_firewall.yml --ask-vault-pass
# =========================================

- name: "üîê CONFIGURAR USUARIOS Y SEGURIDAD DEL LABORATORIO"
  hosts: all
  become: true
  gather_facts: true
  
  vars:
    # ===== VARIABLES DE VAULT (ENCRIPTADAS) =====
    vault_labadmin_password: "{{ vault_admin_password | default('LabAdmin2024!Secure') }}"
    vault_student_password: "{{ vault_student_password | default('Student2024!Lab') }}"
    vault_practice_password: "{{ vault_practice_password | default('Practice2024!Web') }}"
  
  pre_tasks:
    - name: "üìã Mostrar informaci√≥n del sistema"
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "üîê CONFIGURACI√ìN DE USUARIOS Y SEGURIDAD"
          - "=============================================="
          - "üñ•Ô∏è  Host: {{ inventory_hostname }}"
          - "üìã Sistema: {{ ansible_system }} {{ ansible_distribution | default('') }}"
          - "üåê IP: {{ ansible_default_ipv4.address | default('DHCPv6') }}"
          - "‚è∞ Fecha: {{ ansible_date_time.iso8601 }}"
          - "=============================================="
    
    - name: "üîÑ Actualizar cache de paquetes"
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 300
      when: ansible_os_family == "Debian"
      ignore_errors: true

  roles:
    # ===== ROL 1: CONFIGURACI√ìN DE USUARIOS Y GRUPOS =====
    - name: usuarios_seguridad
      tags:
        - usuarios
        - grupos
        - sudo
        - politicas
    
    # ===== ROL 2: CONFIGURACI√ìN DE FIREWALL Y ANTIVIRUS =====  
    - name: seguridad_firewall
      tags:
        - firewall
        - antivirus
        - fail2ban
        - red
        - dhcpv6

  post_tasks:
    - name: "‚úÖ RESUMEN FINAL DE CONFIGURACI√ìN"
      ansible.builtin.debug:
        msg:
          - "==============================================="
          - "‚úÖ CONFIGURACI√ìN COMPLETADA EXITOSAMENTE"
          - "==============================================="
          - "üë• Usuarios creados:"
          - "   ‚Ä¢ labadmin (sudo completo sin contrase√±a)"
          - "   ‚Ä¢ lab_student (sudo limitado con contrase√±a)"
          - "   ‚Ä¢ practice_user (solo servicios web)"
          - ""
          - "üîí Grupos configurados:"
          - "   ‚Ä¢ students, practice, academic_admin, lab_developers"
          - ""
          - "üî• Firewall configurado:"
          - "   ‚Ä¢ SSH(22) - Solo desde 192.168.1.0/24"
          - "   ‚Ä¢ HTTP(80) y HTTPS(443) - Permitidos"
          - "   ‚Ä¢ Puertos peligrosos - Bloqueados"
          - ""
          - "ü¶† Antivirus:"
          - "   ‚Ä¢ Linux: ClamAV activo con escaneo nocturno"
          - "   ‚Ä¢ Windows: Defender optimizado"
          - ""
          - "üõ°Ô∏è  Protecciones adicionales:"
          - "   ‚Ä¢ Fail2ban para SSH (Linux)"
          - "   ‚Ä¢ Pol√≠ticas de contrase√±as seguras"
          - "   ‚Ä¢ Cuentas root/guest deshabilitadas"
          - "   ‚Ä¢ Red DHCPv6 con IPv4 fallback"
          - ""
          - "üìã Host: {{ inventory_hostname }}"
          - "‚è∞ Finalizado: {{ ansible_date_time.iso8601 }}"
          - "==============================================="

    - name: "üîç Verificar servicios cr√≠ticos"
      ansible.builtin.shell: |
        {% if ansible_os_family == "Debian" %}
        echo "=== Servicios Linux ==="
        systemctl is-active ufw || echo "UFW: Revisar"
        systemctl is-active clamav-daemon || echo "ClamAV: Revisar"
        systemctl is-active fail2ban || echo "Fail2ban: Revisar"
        {% elif ansible_os_family == "Windows" %}
        echo "=== Servicios Windows ==="
        Get-Service -Name "mpssvc" | Select-Object Status
        Get-MpComputerStatus | Select-Object AntivirusEnabled
        {% endif %}
      register: services_check
      changed_when: false
      ignore_errors: true

    - name: "üìä Mostrar estado de servicios"
      ansible.builtin.debug:
        var: services_check.stdout_lines
      when: services_check.stdout_lines is defined

# =========================================
# TAGS DISPONIBLES PARA EJECUCI√ìN PARCIAL
# =========================================
# ansible-playbook setup_usuarios_firewall.yml --tags "usuarios"
# ansible-playbook setup_usuarios_firewall.yml --tags "firewall"
# ansible-playbook setup_usuarios_firewall.yml --tags "antivirus"
# ansible-playbook setup_usuarios_firewall.yml --tags "red"