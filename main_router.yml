---
# =============================================================================
# MAIN ROUTER - Orquestador Principal del Framework Ansible
# =============================================================================
# Descripci√≥n: Playbook principal que orquesta todos los roles y tareas
# Tipo: Router/Orchestrator siguiendo best practices
# Hosts: localhost (control node)
# =============================================================================

- name: "üéØ ANSIBLE SECURITY FRAMEWORK - MAIN ROUTER"
  hosts: localhost
  become: true
  become_method: sudo
  gather_facts: yes
  vars:
    # =======================================================================
    # CONFIGURACI√ìN DE ACCIONES V√ÅLIDAS
    # =======================================================================
    valid_actions:
      - infrastructure    # Crear VMs en ESXi/VirtualBox
      - security          # Configurar seguridad integral
      - hardening         # Endurecer sistemas
      - monitoring        # Configurar monitoreo
      - reporting         # Generar reportes
      - validation        # Validar configuraciones
      - cleanup           # Limpiar recursos temporales

    # =======================================================================
    # CONFIGURACI√ìN DE EJECUCI√ìN
    # =======================================================================
    execution_mode: "{{ run_action | default('security') }}"
    target_environment: "{{ environment | default('development') }}"
    enable_reporting: "{{ generate_reports | default(true) }}"

  tasks:
    # =======================================================================
    # VALIDACI√ìN INICIAL
    # =======================================================================
    - name: "üîç VALIDAR PAR√ÅMETROS DE ENTRADA"
      ansible.builtin.assert:
        that:
          - execution_mode in valid_actions
        fail_msg: "‚ùå Acci√≥n no v√°lida: {{ execution_mode }}. Acciones v√°lidas: {{ valid_actions | join(', ') }}"
        success_msg: "‚úÖ Acci√≥n v√°lida: {{ execution_mode }}"

    - name: "üìã MOSTRAR CONFIGURACI√ìN DE EJECUCI√ìN"
      ansible.builtin.debug:
        msg:
          - "=================================================="
          - "üéØ CONFIGURACI√ìN DEL MAIN ROUTER"
          - "=================================================="
          - "Acci√≥n: {{ execution_mode }}"
          - "Entorno: {{ target_environment }}"
          - "Generar reportes: {{ enable_reporting }}"
          - "Host de control: {{ inventory_hostname }}"
          - "Fecha/Hora: {{ ansible_date_time.iso8601 }}"
          - "=================================================="

    # =======================================================================
    # EJECUCI√ìN DE ROLES SEG√öN ACCI√ìN
    # =======================================================================
    
    # --- INFRAESTRUCTURA ---
    - name: "üèóÔ∏è EJECUTAR ROL DE INFRAESTRUCTURA"
      ansible.builtin.include_role:
        name: infrastructure
      when: execution_mode == "infrastructure"
      tags: 
        - infrastructure
        - never

    # --- SEGURIDAD INTEGRAL ---
    - name: "üîê EJECUTAR ROL DE SEGURIDAD"
      ansible.builtin.include_role:
        name: security
      when: execution_mode == "security"
      tags:
        - security

    # --- HARDENING DE SISTEMAS ---
    - name: "üõ°Ô∏è EJECUTAR ROL DE HARDENING"
      ansible.builtin.include_role:
        name: hardening
      when: execution_mode == "hardening"
      tags:
        - hardening
        - never

    # --- MONITOREO ---
    - name: "üìä EJECUTAR ROL DE MONITOREO"
      ansible.builtin.include_role:
        name: monitoring
      when: execution_mode == "monitoring"
      tags:
        - monitoring

    # --- REPORTES ---
    - name: "üìã GENERAR REPORTES DE SISTEMA"
      ansible.builtin.include_tasks: reporting/generate_reports.yml
      when: execution_mode == "reporting" or enable_reporting | bool
      tags:
        - reporting

    # --- VALIDACI√ìN ---
    - name: "‚úÖ EJECUTAR VALIDACIONES"
      ansible.builtin.include_tasks: validation/validate_all.yml
      when: execution_mode == "validation"
      tags:
        - validation

    # --- LIMPIEZA ---
    - name: "üßπ EJECUTAR LIMPIEZA DE RECURSOS"
      ansible.builtin.include_tasks: cleanup/cleanup_resources.yml
      when: execution_mode == "cleanup"
      tags:
        - cleanup
        - never

    # =======================================================================
    # RESUMEN FINAL
    # =======================================================================
    - name: "üéØ RESUMEN DE EJECUCI√ìN COMPLETADA"
      ansible.builtin.debug:
        msg:
          - "=================================================="
          - "‚úÖ MAIN ROUTER - EJECUCI√ìN COMPLETADA"
          - "=================================================="
          - "Acci√≥n ejecutada: {{ execution_mode }}"
          - "Estado: EXITOSO"
          - "Tiempo de ejecuci√≥n: {{ ansible_date_time.iso8601 }}"
          - "Host procesado: {{ inventory_hostname }}"
          - ""
          - "üìä Pr√≥ximos pasos recomendados:"
          - "  1. Revisar logs generados"
          - "  2. Validar configuraciones aplicadas"
          - "  3. Ejecutar tests de conectividad"
          - ""
          - "üîß Comandos √∫tiles:"
          - "  # Validar: ansible-playbook main_router.yml -e action=validation"
          - "  # Reportes: ansible-playbook main_router.yml -e action=reporting"
          - "  # Monitoreo: ansible-playbook main_router.yml -e action=monitoring"
          - "=================================================="
      tags:
        - always

# =============================================================================
# EJEMPLOS DE USO DEL MAIN ROUTER
# =============================================================================
# 
# # Ejecuci√≥n por defecto (seguridad)
# ansible-playbook main_router.yml
# 
# # Crear infraestructura
# ansible-playbook main_router.yml -e action=infrastructure
# 
# # Hardening de sistemas
# ansible-playbook main_router.yml -e action=hardening
# 
# # Generar reportes
# ansible-playbook main_router.yml -e action=reporting
# 
# # Validar configuraciones
# ansible-playbook main_router.yml -e action=validation
# 
# # Limpiar recursos
# ansible-playbook main_router.yml -e action=cleanup
# 
# # Ejecuci√≥n con tags espec√≠ficos
# ansible-playbook main_router.yml --tags security,monitoring
# 
# # Ejecuci√≥n en entorno espec√≠fico
# ansible-playbook main_router.yml -e environment=production
# 
# =============================================================================